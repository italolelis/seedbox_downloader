---
phase: 12-in-progress-visibility
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - internal/transfer/transfer.go
  - internal/dc/putio/client.go
  - internal/dc/putio/client_test.go
autonomous: true

must_haves:
  truths:
    - "In-progress transfers (FileID==0) are returned by GetTaggedTorrents, not filtered out"
    - "Completed transfers still have their Files array populated via getFilesRecursively"
    - "In-progress transfers have empty Files array (no API call to get files when FileID==0)"
    - "DownloadSpeed from Put.io is mapped to transfer.Transfer.DownloadSpeed field"
    - "IsAvailable() returns false for in-progress statuses (downloading, in_queue, waiting)"
    - "IsDownloadable() returns false for transfers with empty Files array"
  artifacts:
    - path: "internal/transfer/transfer.go"
      provides: "Transfer struct with DownloadSpeed field"
      contains: "DownloadSpeed"
    - path: "internal/dc/putio/client.go"
      provides: "GetTaggedTorrents returning in-progress transfers with conditional file population"
      contains: "if t.FileID != 0"
    - path: "internal/dc/putio/client_test.go"
      provides: "Tests verifying in-progress transfers returned and completed transfers have files"
      contains: "in_progress_transfer_returned"
  key_links:
    - from: "internal/dc/putio/client.go"
      to: "internal/transfer/transfer.go"
      via: "Transfer struct DownloadSpeed field population"
      pattern: "DownloadSpeed.*int64.*t\\.DownloadSpeed"
    - from: "internal/dc/putio/client.go"
      to: "internal/dc/putio/client.go:getFilesRecursively"
      via: "Conditional file population guarded by FileID != 0"
      pattern: "if t\\.FileID != 0"
---

<objective>
Remove the FileID==0 filter from GetTaggedTorrents so in-progress transfers are returned to callers, add conditional file population to avoid API errors for in-progress transfers, and add DownloadSpeed to the Transfer struct.

Purpose: This is the foundational data-layer change that enables in-progress transfers to flow through the system. Without this, Sonarr/Radarr Activity tab cannot see active downloads. The triple safety net (IsAvailable + IsDownloadable + conditional files) prevents the download pipeline from processing in-progress transfers.

Output: Modified GetTaggedTorrents that returns ALL tagged transfers (in-progress and completed), with files only populated for completed transfers.
</objective>

<execution_context>
@/Users/italovietro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/italovietro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-in-progress-visibility/12-RESEARCH.md
@.planning/phases/11-saveparentid-tag-matching/11-01-SUMMARY.md
@internal/transfer/transfer.go
@internal/dc/putio/client.go
@internal/dc/putio/client_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DownloadSpeed to Transfer struct, write tests for in-progress transfer handling in GetTaggedTorrents</name>
  <files>internal/transfer/transfer.go, internal/dc/putio/client_test.go</files>
  <action>
**Step 1: Add DownloadSpeed field to Transfer struct** in `internal/transfer/transfer.go`:
- Add `DownloadSpeed int64` field to the Transfer struct (after `Downloaded int64` for logical grouping)
- No other struct changes needed -- PeersConnected, PeersGettingFromUs, PeersSendingToUs already exist

**Step 2: Add new test cases** to `TestGetTaggedTorrents_SaveParentIDMatching` in `internal/dc/putio/client_test.go`:

Add these new test cases to the existing table-driven test:

1. **`in_progress_transfer_returned`**: Transfer with FileID=0, SaveParentID=200, status=DOWNLOADING, percent_done=50, size=2000, downloaded=1000, peers_connected=5, peers_sending_to_us=3, down_speed=1048576. FileHandler for 200 returns matching tag folder. Expect: wantCount=1, verify transfer has empty Files array, verify transfer.PeersConnected==5, verify transfer.PeersSendingToUs==3, verify transfer.DownloadSpeed==1048576.

2. **`completed_transfer_has_files`**: Transfer with FileID=100, SaveParentID=200, status=COMPLETED, percent_done=100. FileHandlers for 200 (tag folder) and 100 (video file). Expect: wantCount=1, verify transfer.Files has length > 0.

3. **`mixed_inprogress_and_completed`**: Two transfers -- one in-progress (FileID=0, SaveParentID=200, status=DOWNLOADING) and one completed (FileID=100, SaveParentID=200, status=COMPLETED). FileHandlers for 200 (tag folder) and 100 (video file). Expect: wantCount=2, first transfer has empty Files, second transfer has populated Files.

**Important:** The existing `fileid_zero` test case currently expects wantCount=0 (because FileID==0 is filtered). This test must be UPDATED to reflect the new behavior: rename it to something like `fileid_zero_still_needs_saveparentid` and keep wantCount=0 only if it has SaveParentID=0 (already filtered). Or update the existing `fileid_zero` case to have SaveParentID=200 with a matching file handler, and change wantCount to 1 since FileID=0 should no longer filter the transfer.

Actually, looking at the existing test: the `fileid_zero` test has SaveParentID=200 but NO file handler for "200", so it would fail on the Files.Get(SaveParentID) call. Update this test to:
- Add a file handler for "200" returning the matching tag folder
- Change wantCount from 0 to 1
- Add verification that the returned transfer has empty Files array
- Update the test name to `in_progress_fileid_zero_returned`

Run tests -- they MUST FAIL (RED phase) because GetTaggedTorrents still filters FileID==0 and doesn't populate DownloadSpeed.
  </action>
  <verify>
`cd /Users/italovietro/projects/seedbox_downloader && go test ./internal/dc/putio/ -run TestGetTaggedTorrents -v` shows the new test cases FAILING (expected count mismatch because FileID==0 filter still active). Existing passing tests may also fail due to the `fileid_zero` update. `go vet ./...` passes. `go build ./...` passes (struct change is additive).
  </verify>
  <done>
Transfer struct has DownloadSpeed field. Test cases exist that verify: (1) in-progress transfers are returned, (2) completed transfers have files, (3) mixed transfers work correctly, (4) DownloadSpeed is populated. Tests are RED (failing).
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement FileID filter removal, conditional file population, and DownloadSpeed mapping</name>
  <files>internal/dc/putio/client.go</files>
  <action>
Modify `GetTaggedTorrents` in `internal/dc/putio/client.go` to make the failing tests pass:

**Step 1: Remove the FileID==0 filter** (lines 52-56):
Delete the entire `if t.FileID == 0 { ... continue }` block. This is the key change that allows in-progress transfers through.

**Step 2: Make file fetching conditional on FileID != 0**:
Replace the unconditional `file, err := c.putioClient.Files.Get(ctx, t.FileID)` block (lines 79-84) and the unconditional `files, err := c.getFilesRecursively(ctx, file.ID, file.Name)` block (lines 104-109) with conditional logic:

```go
// Only fetch file details and populate Files for completed transfers (FileID != 0)
if t.FileID != 0 {
    file, err := c.putioClient.Files.Get(ctx, t.FileID)
    if err != nil {
        logger.ErrorContext(ctx, "failed to get file", "transfer_id", t.ID, "err", err)
        continue
    }

    files, err := c.getFilesRecursively(ctx, file.ID, file.Name)
    if err != nil {
        logger.ErrorContext(ctx, "failed to get files for completed transfer",
            "transfer_id", t.ID, "file_id", t.FileID, "err", err)
        // Continue anyway -- transfer visible in Activity tab but without files
        // Download pipeline will skip it via IsDownloadable() check
    } else {
        torrent.Files = append(torrent.Files, files...)
    }
}
```

Note: For file population errors on completed transfers, log the error but do NOT return an error or skip the transfer. The transfer should still appear in the Activity tab. The download pipeline will skip it because IsDownloadable() returns false for empty Files.

**Step 3: Add DownloadSpeed to transfer construction**:
In the `torrent := &transfer.Transfer{...}` block (lines 87-102), add:
```go
DownloadSpeed: int64(t.DownloadSpeed),
```
Note: The go-putio field is `DownloadSpeed` (type int), which maps to JSON `down_speed`.

**Step 4: Verify the existing `SavePath` field**:
Currently `SavePath: "/" + tag`. This is fine for all transfers (both in-progress and completed) since the save path is always the tag folder.

Run tests to confirm GREEN.
  </action>
  <verify>
`cd /Users/italovietro/projects/seedbox_downloader && go test ./internal/dc/putio/ -run TestGetTaggedTorrents -v` -- ALL test cases pass (GREEN). `go test ./... -count=1` -- all project tests pass. `go vet ./...` -- no issues. `go build ./...` -- compiles cleanly.
  </verify>
  <done>
GetTaggedTorrents returns in-progress transfers (FileID==0 no longer filtered). Completed transfers have files populated. In-progress transfers have empty Files array. DownloadSpeed field populated. All tests GREEN. The triple safety net (IsAvailable + IsDownloadable + conditional files) prevents download pipeline from processing in-progress transfers.
  </done>
</task>

</tasks>

<verification>
1. `go test ./internal/dc/putio/ -v` -- All GetTaggedTorrents tests pass
2. `go test ./internal/transfer/ -v` -- Transfer struct tests pass (if any)
3. `go test ./... -count=1` -- Full test suite passes (no regressions)
4. `go vet ./...` -- No vet issues
5. `go build ./...` -- Compiles cleanly

Verify triple safety net manually:
- In-progress transfer: Status="downloading" -> IsAvailable()=false, Files=[] -> IsDownloadable()=false
- Completed transfer: Status="completed" -> IsAvailable()=true, Files=[...] -> IsDownloadable()=true
</verification>

<success_criteria>
- GetTaggedTorrents returns both in-progress and completed transfers
- In-progress transfers have empty Files array
- Completed transfers have populated Files array
- DownloadSpeed field populated from Put.io Transfer.DownloadSpeed
- Download pipeline safety net verified (IsAvailable + IsDownloadable)
- All existing tests pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/12-in-progress-visibility/12-01-SUMMARY.md`
</output>
