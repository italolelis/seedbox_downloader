---
phase: 12-in-progress-visibility
plan: 02
type: tdd
wave: 2
depends_on: ["12-01"]
files_modified:
  - internal/http/rest/transmission.go
  - internal/http/rest/transmission_test.go
autonomous: true

must_haves:
  truths:
    - "In-progress transfers appear in torrent-get response with correct Transmission status codes"
    - "downloading maps to StatusDownload(4), in_queue/waiting to StatusDownloadWait(3), finishing/checking to StatusCheck(2)"
    - "Error transfers show StatusStopped(0) with ErrorString populated from transfer.ErrorMessage"
    - "Unknown statuses log a warning and default to StatusStopped(0)"
    - "Peer count and download speed fields are populated in the Transmission torrent response"
    - "Each torrent response includes a labels array with the configured proxy label"
  artifacts:
    - path: "internal/http/rest/transmission.go"
      provides: "TransmissionTorrent struct with Labels, PeersConnected, PeersSendingToUs, PeersGettingFromUs, RateDownload fields; complete status mapping; error string handling"
      contains: "Labels"
    - path: "internal/http/rest/transmission_test.go"
      provides: "Tests for status mapping, peer fields, labels, and error string population"
      contains: "TestHandleTorrentGet"
  key_links:
    - from: "internal/http/rest/transmission.go:handleTorrentGet"
      to: "internal/transfer/transfer.go:Transfer"
      via: "Maps Transfer.DownloadSpeed to TransmissionTorrent.RateDownload"
      pattern: "RateDownload.*transfer\\.DownloadSpeed"
    - from: "internal/http/rest/transmission.go:handleTorrentGet"
      to: "internal/http/rest/transmission.go:TransmissionTorrent"
      via: "Labels populated from h.label config"
      pattern: "Labels.*h\\.label"
---

<objective>
Add Labels, PeersConnected, PeersSendingToUs, PeersGettingFromUs, and RateDownload fields to TransmissionTorrent struct. Complete the status mapping for all Put.io statuses. Populate error string for error transfers. Wire peer/speed data from transfer.Transfer to the Transmission response.

Purpose: This completes the Activity tab integration -- Sonarr/Radarr will see in-progress downloads with accurate status, speed, peer counts, and labels in the torrent-get response.

Output: Fully populated TransmissionTorrent responses for both in-progress and completed transfers.
</objective>

<execution_context>
@/Users/italovietro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/italovietro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-in-progress-visibility/12-RESEARCH.md
@.planning/phases/12-in-progress-visibility/12-01-SUMMARY.md
@internal/http/rest/transmission.go
@internal/http/rest/transmission_test.go
@internal/transfer/transfer.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write tests for complete status mapping, peer/speed fields, labels, and error string in handleTorrentGet</name>
  <files>internal/http/rest/transmission.go, internal/http/rest/transmission_test.go</files>
  <action>
**Step 1: Add new fields to TransmissionTorrent struct** in `internal/http/rest/transmission.go`:
Add these fields to the `TransmissionTorrent` struct (after `DownloadedEver` and before `SeedRatioLimit`):

```go
Labels             []string `json:"labels"`
PeersConnected     int64    `json:"peersConnected"`
PeersSendingToUs   int64    `json:"peersSendingToUs"`
PeersGettingFromUs int64    `json:"peersGettingFromUs"`
RateDownload       int64    `json:"rateDownload"`
```

Note on `Labels`: Use `json:"labels"` (NOT `omitempty`) -- Sonarr/Radarr expects the field to always be present. An empty array `[]` is acceptable, but omitting the field entirely could cause client-side issues.

**Step 2: Update mockPutioClient.GetTaggedTorrents** in `internal/http/rest/transmission_test.go`:
The mock currently returns an empty slice. Add a `getTaggedTorrentsFunc` field to the mock struct so tests can control what transfers are returned:

```go
type mockPutioClient struct {
    // ... existing fields ...
    getTaggedTorrentsFunc func(ctx context.Context, label string) ([]*transfer.Transfer, error)
}

func (m *mockPutioClient) GetTaggedTorrents(ctx context.Context, label string) ([]*transfer.Transfer, error) {
    if m.getTaggedTorrentsFunc != nil {
        return m.getTaggedTorrentsFunc(ctx, label)
    }
    return []*transfer.Transfer{}, nil
}
```

**Step 3: Write `TestHandleTorrentGet_StatusMapping` test** in `internal/http/rest/transmission_test.go`:
Table-driven test with these cases:

| Put.io Status | Expected Transmission Status | Expected StatusCode |
|---------------|------------------------------|---------------------|
| "DOWNLOADING" | StatusDownload | 4 |
| "IN_QUEUE" | StatusDownloadWait | 3 |
| "WAITING" | StatusDownloadWait | 3 |
| "FINISHING" | StatusCheck | 2 |
| "CHECKING" | StatusCheck | 2 |
| "COMPLETED" | StatusSeed | 6 |
| "FINISHED" | StatusSeed | 6 |
| "SEEDING" | StatusSeed | 6 |
| "SEEDINGWAIT" | StatusSeedWait | 5 |
| "ERROR" | StatusStopped | 0 |
| "UNKNOWN_NEW_STATUS" | StatusStopped | 0 |

For each case:
- Create a mock that returns one transfer with the given status, ID="1", Name="test", Size=1000
- Send a torrent-get RPC request
- Parse the response, extract the torrent's `status` field
- Assert status equals expected value

**Step 4: Write `TestHandleTorrentGet_ErrorStringPopulated` test**:
- Create a transfer with Status="ERROR", ErrorMessage="tracker unreachable"
- Send torrent-get request
- Assert the response torrent has `errorString` == "tracker unreachable"
- Also test: transfer with Status="COMPLETED", ErrorMessage="" -> errorString should be empty/nil

**Step 5: Write `TestHandleTorrentGet_PeerAndSpeedFields` test**:
- Create a transfer with PeersConnected=10, PeersSendingToUs=5, PeersGettingFromUs=3, DownloadSpeed=5242880 (5MB/s)
- Send torrent-get request
- Assert: peersConnected==10, peersSendingToUs==5, peersGettingFromUs==3, rateDownload==5242880

**Step 6: Write `TestHandleTorrentGet_LabelsPopulated` test**:
- Create handler with label="mytag"
- Create a transfer
- Send torrent-get request
- Assert: response torrent has `labels` == ["mytag"]

Run tests -- they MUST FAIL (RED) because handleTorrentGet doesn't populate the new fields yet and status mapping is incomplete.
  </action>
  <verify>
`cd /Users/italovietro/projects/seedbox_downloader && go test ./internal/http/rest/ -run "TestHandleTorrentGet_(StatusMapping|ErrorString|PeerAndSpeed|Labels)" -v` shows new tests FAILING. `go vet ./...` passes. `go build ./...` passes (struct changes are additive, labels field is always present).
  </verify>
  <done>
TransmissionTorrent struct has Labels, PeersConnected, PeersSendingToUs, PeersGettingFromUs, RateDownload fields. Tests exist for complete status mapping (all 8 Put.io statuses + unknown), error string population, peer/speed fields, and labels. Tests are RED (failing).
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement complete status mapping, error string handling, peer/speed population, and labels in handleTorrentGet</name>
  <files>internal/http/rest/transmission.go</files>
  <action>
Modify `handleTorrentGet` in `internal/http/rest/transmission.go` to make the failing tests pass:

**Step 1: Complete the status mapping switch statement** (lines 473-486):
Replace the existing incomplete switch statement with:

```go
var status TransmissionTorrentStatus
var errorString *string

switch strings.ToLower(transfer.Status) {
case "downloading":
    status = StatusDownload // 4
case "in_queue", "waiting":
    status = StatusDownloadWait // 3
case "finishing", "checking":
    status = StatusCheck // 2
case "completed", "finished":
    status = StatusSeed // 6
case "seeding":
    status = StatusSeed // 6
case "seedingwait":
    status = StatusSeedWait // 5
case "error":
    status = StatusStopped // 0
    if transfer.ErrorMessage != "" {
        errorString = &transfer.ErrorMessage
    }
default:
    logger.WarnContext(ctx, "unknown put.io transfer status, defaulting to stopped",
        "status", transfer.Status, "transfer_id", transfer.ID)
    status = StatusStopped // 0
}
```

**Step 2: Update ErrorString handling**:
The current code on line 500 sets `ErrorString: &transfer.ErrorMessage` for ALL transfers. This is wrong -- it should only be set for error transfers. Change to use the `errorString` variable from the switch statement above. For non-error transfers, ErrorString should be nil (omitted from JSON via `omitempty`).

**Step 3: Populate new fields in TransmissionTorrent construction** (lines 490-507):
Add these fields to the TransmissionTorrent literal:

```go
Labels:             []string{h.label},
PeersConnected:     transfer.PeersConnected,
PeersSendingToUs:   transfer.PeersSendingToUs,
PeersGettingFromUs: transfer.PeersGettingFromUs,
RateDownload:       transfer.DownloadSpeed,
```

And update ErrorString:
```go
ErrorString: errorString, // Only populated for error transfers
```

**Step 4: Update IsFinished logic**:
Current line 497: `IsFinished: strings.ToLower(transfer.Status) == "completed" || strings.ToLower(transfer.Status) == "seeding"`.
Add "finished" to the check:
```go
IsFinished: strings.ToLower(transfer.Status) == "completed" ||
            strings.ToLower(transfer.Status) == "seeding" ||
            strings.ToLower(transfer.Status) == "finished",
```

Run tests to confirm GREEN.
  </action>
  <verify>
`cd /Users/italovietro/projects/seedbox_downloader && go test ./internal/http/rest/ -v` -- ALL tests pass (GREEN, including both new and existing tests). `go test ./... -count=1` -- full project test suite passes. `go vet ./...` -- no issues. `go build ./...` -- compiles cleanly.
  </verify>
  <done>
handleTorrentGet returns complete status mapping for all Put.io statuses. Error transfers have ErrorString populated. Peer/speed fields populated from transfer data. Labels array populated with configured proxy label. Unknown statuses trigger warn log and default to StatusStopped. All tests GREEN.
  </done>
</task>

</tasks>

<verification>
1. `go test ./internal/http/rest/ -v` -- All transmission handler tests pass
2. `go test ./... -count=1` -- Full test suite passes (no regressions)
3. `go vet ./...` -- No vet issues
4. `go build ./...` -- Compiles cleanly

Verify complete status coverage:
- downloading -> StatusDownload(4)
- in_queue, waiting -> StatusDownloadWait(3)
- finishing, checking -> StatusCheck(2)
- completed, finished, seeding -> StatusSeed(6)
- seedingwait -> StatusSeedWait(5)
- error -> StatusStopped(0) + ErrorString
- unknown -> StatusStopped(0) + warn log
</verification>

<success_criteria>
- All 8 Put.io statuses correctly mapped to Transmission status codes
- Error transfers include ErrorString from transfer.ErrorMessage
- Unknown statuses produce warn log and default to StatusStopped
- Labels array populated with configured label for all transfers
- PeersConnected, PeersSendingToUs, PeersGettingFromUs, RateDownload populated
- Existing torrent-add, torrent-remove, authentication tests still pass
- Full project test suite passes
</success_criteria>

<output>
After completion, create `.planning/phases/12-in-progress-visibility/12-02-SUMMARY.md`
</output>
