---
phase: 11-saveparentid-tag-matching
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - internal/dc/putio/client.go
  - internal/dc/putio/client_test.go
autonomous: true

must_haves:
  truths:
    - "Completed transfers are matched to their label using SaveParentID instead of the FileID->ParentID lookup chain"
    - "Transfers with SaveParentID==0 are skipped gracefully with a debug log (not an error)"
    - "Transfers with FileID==0 are still skipped (existing filter preserved)"
    - "Existing download pipeline behavior is unchanged -- same transfers returned, same filter logic"
  artifacts:
    - path: "internal/dc/putio/client.go"
      provides: "SaveParentID-based tag matching in GetTaggedTorrents"
      contains: "Files.Get(ctx, t.SaveParentID)"
    - path: "internal/dc/putio/client_test.go"
      provides: "Tests for GetTaggedTorrents SaveParentID matching"
      contains: "TestGetTaggedTorrents"
  key_links:
    - from: "internal/dc/putio/client.go"
      to: "putio.Transfer.SaveParentID"
      via: "Files.Get for parent folder lookup"
      pattern: "Files\\.Get\\(ctx, t\\.SaveParentID\\)"
    - from: "internal/dc/putio/client.go"
      to: "putio.File.Name"
      via: "parent folder name compared to tag"
      pattern: "parent\\.Name != tag"
---

<objective>
Test and validate SaveParentID-based tag matching in GetTaggedTorrents

Purpose: The implementation already exists (uncommitted in working tree) that replaces the FileID->ParentID->Files.Get lookup chain with a direct Files.Get(SaveParentID) call for tag matching. This plan writes comprehensive tests to validate all scenarios before committing, ensuring the change is safe and the three phase success criteria are met.

Output: Tested and committed SaveParentID tag matching with full scenario coverage
</objective>

<execution_context>
@/Users/italovietro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/italovietro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@internal/dc/putio/client.go
@internal/dc/putio/client_test.go
</context>

<feature>
  <name>GetTaggedTorrents SaveParentID Tag Matching</name>
  <files>internal/dc/putio/client.go, internal/dc/putio/client_test.go</files>
  <behavior>
    GetTaggedTorrents(ctx, tag) uses SaveParentID to determine if a transfer belongs to the given tag:

    Case 1: Transfer with FileID=100, SaveParentID=200, parent folder name matches tag
      -> Transfer IS returned in results (with files populated)

    Case 2: Transfer with FileID=100, SaveParentID=200, parent folder name does NOT match tag
      -> Transfer is SKIPPED (not in results)

    Case 3: Transfer with SaveParentID=0
      -> Transfer is SKIPPED with debug log (not an error)

    Case 4: Transfer with FileID=0
      -> Transfer is SKIPPED with debug log (existing behavior preserved)

    Case 5: Files.Get(SaveParentID) returns error
      -> Transfer is SKIPPED, error is logged, processing continues for remaining transfers

    Case 6: Multiple transfers, mix of matching and non-matching
      -> Only matching transfers returned, order preserved

    Case 7: Transfer where parent folder is a directory matching the tag, file is a single file (not a directory)
      -> Transfer returned with single file in Files array
  </behavior>
  <implementation>
    The implementation already exists in the working tree (uncommitted changes to client.go).
    The change replaces:
      Files.Get(FileID) -> file.ParentID -> Files.Get(ParentID) -> parent.Name == tag
    With:
      Files.Get(SaveParentID) -> parent.Name == tag

    The FileID==0 filter is KEPT in place (Phase 12 removes it).
    The Files.Get(FileID) call is MOVED after tag matching (needed for getFilesRecursively).

    Tests must use httptest to mock the Put.io API. Pattern from go-putio library:
    1. Create httptest.Server with http.ServeMux
    2. Create go-putio client with NewClient(nil)
    3. Override client.BaseURL to point to test server
    4. Register handlers on mux for /v2/transfers/list, /v2/files/{id}
    5. Create our putio.Client wrapping the go-putio client

    API response formats:
    - GET /v2/transfers/list -> {"Transfers": [...]}
    - GET /v2/files/{id} -> {"file": {...}}
    - GET /v2/files/list?parent_id={id}&per_page=1000 -> {"files": [...], "parent": {...}}

    IMPORTANT: Our putio.Client struct has unexported field `putioClient *putio.Client`.
    The test needs to be in the same package (package putio, not putio_test) to access it.
    This is the existing pattern -- current tests are in `package putio`.

    To construct a testable client:
    ```go
    func newTestClient(serverURL string) *Client {
        goputioClient := putio.NewClient(nil)
        u, _ := url.Parse(serverURL)
        goputioClient.BaseURL = u
        return &Client{putioClient: goputioClient}
    }
    ```
  </implementation>
</feature>

<tasks>

<task type="auto">
  <name>Task 1: Write GetTaggedTorrents tests with httptest mock server</name>
  <files>internal/dc/putio/client_test.go</files>
  <action>
    Add comprehensive tests for GetTaggedTorrents to the existing client_test.go file. Keep existing tests (TestValidateTorrentFilename_ValidExtensions, TestAddTransferByBytes_*).

    Add a test helper function:
    ```go
    func newTestClient(serverURL string) *Client {
        goputioClient := putio.NewClient(nil)
        u, _ := url.Parse(serverURL)
        goputioClient.BaseURL = u
        return &Client{putioClient: goputioClient}
    }
    ```

    Add imports: "net/http", "net/http/httptest", "net/url", "fmt", "strings", "github.com/putdotio/go-putio", "github.com/stretchr/testify/assert" (testify is already a project dependency).

    Write table-driven tests for GetTaggedTorrents using the project convention (table-driven with t.Run):

    **TestGetTaggedTorrents_SaveParentIDMatching** - Tests the core SaveParentID tag matching:
    - Subtest "matching_tag": Transfer with FileID=100, SaveParentID=200. Mock /v2/files/200 returns folder with name="mytag". Mock /v2/files/100 returns a file (not dir). Mock /v2/files/list for file enumeration returns the file. Call GetTaggedTorrents(ctx, "mytag"). Assert 1 transfer returned with correct ID, Name, Label="mytag".
    - Subtest "non_matching_tag": Transfer with FileID=100, SaveParentID=200. Mock /v2/files/200 returns folder with name="othertag". Call GetTaggedTorrents(ctx, "mytag"). Assert 0 transfers returned.
    - Subtest "saveparentid_zero": Transfer with FileID=100, SaveParentID=0. Call GetTaggedTorrents(ctx, "mytag"). Assert 0 transfers returned (skipped gracefully).
    - Subtest "fileid_zero": Transfer with FileID=0, SaveParentID=200. Call GetTaggedTorrents(ctx, "mytag"). Assert 0 transfers returned (existing filter).
    - Subtest "parent_fetch_error": Transfer with FileID=100, SaveParentID=999. Mock /v2/files/999 returns 500 error. Call GetTaggedTorrents(ctx, "mytag"). Assert 0 transfers returned, no error from function (individual transfer errors are logged and skipped).
    - Subtest "multiple_transfers_mixed": 3 transfers: one matching, one non-matching tag, one with SaveParentID=0. Assert only the matching one returned.

    For each subtest:
    1. Create http.ServeMux and httptest.NewServer
    2. Register handler for /v2/transfers/list returning Transfer JSON with appropriate fields
    3. Register handlers for /v2/files/{id} as needed
    4. For file enumeration: when Files.Get returns a non-directory file, getFilesRecursively returns it directly. So mock /v2/files/{fileID} to return a file (file_type: "file", not a folder).
    5. Create test client with newTestClient(server.URL)
    6. Call GetTaggedTorrents and assert results

    JSON response format for transfers list:
    ```json
    {"Transfers": [{"id": 1, "name": "test-transfer", "file_id": 100, "save_parent_id": 200, "status": "COMPLETED", "percent_done": 100, "size": 1000, "source": "magnet:test", "peers_connected": 0, "peers_getting_from_us": 0, "peers_sending_to_us": 0, "downloaded": 1000}]}
    ```

    JSON response format for Files.Get:
    ```json
    {"file": {"id": 200, "name": "mytag", "size": 0, "file_type": "FOLDER", "content_type": "application/x-directory"}}
    ```
    For a regular file:
    ```json
    {"file": {"id": 100, "name": "test-file.mkv", "size": 1000, "file_type": "VIDEO", "content_type": "video/x-matroska"}}
    ```

    IMPORTANT: The go-putio File.IsDir() method checks `ContentType == "application/x-directory"`. Make sure folder mocks set content_type to "application/x-directory".

    Use the mux path routing to handle multiple /v2/files/{id} endpoints. Use strings.TrimPrefix(r.URL.Path, "/v2/files/") to extract the file ID and switch on it.

    Note: For file enumeration via getFilesRecursively, when Files.Get returns a non-directory file, it returns that file directly without calling Files.List. So only a Files.Get mock is needed for the file, not a Files.List mock, when the file is not a directory.
  </action>
  <verify>
    Run: `go test -v -run TestGetTaggedTorrents ./internal/dc/putio/...`
    All subtests pass. At least 6 test cases covering matching, non-matching, SaveParentID=0, FileID=0, error, and mixed scenarios.
  </verify>
  <done>
    All GetTaggedTorrents test cases pass, covering: tag match via SaveParentID, tag mismatch skip, SaveParentID==0 skip, FileID==0 skip, API error handling, and mixed transfer filtering.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify no regressions and validate build</name>
  <files>internal/dc/putio/client.go, internal/dc/putio/client_test.go</files>
  <action>
    Run the full test suite and linter to confirm no regressions:
    1. Run `go test ./...` -- all tests must pass
    2. Run `go build ./...` -- clean build
    3. Run `go vet ./...` -- no vet issues
    4. If golangci-lint is available, run `golangci-lint run ./internal/dc/putio/...` -- no lint errors

    Review the diff one final time to confirm:
    - The FileID==0 filter is still present (line ~52 of client.go)
    - SaveParentID==0 check logs at Debug level (not Error)
    - Files.Get(SaveParentID) error logs at Error level and continues (not returns)
    - The parent.Name != tag comparison still works for directory matching
    - Files.Get(FileID) is still called for file enumeration after tag matching
    - The Transfer struct population includes all fields (Label, SavePath, PeersConnected, etc.)

    Do NOT modify client.go -- the implementation is already correct. Only verify.
  </action>
  <verify>
    `go test ./...` passes with 0 failures.
    `go build ./...` succeeds.
    `go vet ./...` reports no issues.
  </verify>
  <done>
    Full project builds, all tests pass (both existing and new), no lint/vet issues. The SaveParentID implementation is validated and ready for commit.
  </done>
</task>

</tasks>

<verification>
Phase 11 success criteria validation:
1. "Completed transfers are matched to their label using SaveParentID" -- Verified by TestGetTaggedTorrents_SaveParentIDMatching/matching_tag: transfer with SaveParentID pointing to folder named "mytag" is returned when querying tag "mytag"
2. "Transfers with SaveParentID==0 are skipped gracefully with a debug log" -- Verified by TestGetTaggedTorrents_SaveParentIDMatching/saveparentid_zero: transfer is not returned, no error
3. "Existing download pipeline behavior is unchanged" -- Verified by TestGetTaggedTorrents_SaveParentIDMatching/fileid_zero: FileID filter still active; go test ./... passes all existing tests
</verification>

<success_criteria>
- All new GetTaggedTorrents tests pass (6+ scenarios)
- All existing tests pass (TestValidateTorrentFilename, TestAddTransferByBytes)
- go build ./... succeeds
- go vet ./... clean
- Code uses Files.Get(SaveParentID) for tag matching (grep confirms)
- FileID==0 filter still present in client.go
- SaveParentID==0 logs at Debug level (not Error)
</success_criteria>

<output>
After completion, create `.planning/phases/11-saveparentid-tag-matching/11-01-SUMMARY.md`
</output>
