---
phase: 03-operational-hygiene
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/storage/sqlite/init.go
  - cmd/seedbox_downloader/main.go
autonomous: true

must_haves:
  truths:
    - "Database connection failures are detected at startup with retry attempts"
    - "Application exits with clear error message if database unreachable after retries"
    - "Connection pool limits prevent resource exhaustion"
  artifacts:
    - path: "internal/storage/sqlite/init.go"
      provides: "Database initialization with ping validation and pool configuration"
      contains: "db.Ping"
    - path: "cmd/seedbox_downloader/main.go"
      provides: "Environment variables for pool limits"
      contains: "DB_MAX_OPEN_CONNS"
  key_links:
    - from: "cmd/seedbox_downloader/main.go"
      to: "internal/storage/sqlite/init.go"
      via: "InitDB call with context for retry"
      pattern: "sqlite\\.InitDB"
---

<objective>
Add database connection validation with retry logic and connection pool configuration.

Purpose: Critical dependency validation at startup - database must be reachable before the application continues. Pool limits prevent resource exhaustion in long-running deployments.

Output: Database initialization validates connectivity with 3 retries using exponential backoff, then configures connection pool limits from environment variables.
</objective>

<execution_context>
@/Users/italovietro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/italovietro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-operational-hygiene/03-CONTEXT.md

@internal/storage/sqlite/init.go
@cmd/seedbox_downloader/main.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add connection pool config to main.go</name>
  <files>cmd/seedbox_downloader/main.go</files>
  <action>
Add two new fields to the config struct for database pool configuration:

```go
DBMaxOpenConns int `envconfig:"DB_MAX_OPEN_CONNS" default:"25"`
DBMaxIdleConns int `envconfig:"DB_MAX_IDLE_CONNS" default:"5"`
```

These fields use envconfig struct tags with sensible defaults. The defaults (25 open, 5 idle) are appropriate for SQLite which has limited concurrency.

Pass these values to InitDB in initializeServices(). Change the InitDB call to also pass the pool configuration values.
  </action>
  <verify>
Run `go build ./...` - should compile without errors.
Grep for DB_MAX_OPEN_CONNS in main.go to confirm field exists.
  </verify>
  <done>
Config struct has DBMaxOpenConns and DBMaxIdleConns fields with envconfig tags and defaults. InitDB receives pool configuration.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add ping validation and pool config to InitDB</name>
  <files>internal/storage/sqlite/init.go</files>
  <action>
Update InitDB to:

1. Accept additional parameters: `ctx context.Context`, `maxOpenConns int`, `maxIdleConns int`

2. After sql.Open, call db.SetMaxOpenConns(maxOpenConns) and db.SetMaxIdleConns(maxIdleConns)

3. Add db.Ping() validation with exponential backoff retry using cenkalti/backoff/v5:
   - Import "github.com/cenkalti/backoff/v5"
   - Create exponential backoff with 3 max retries
   - Wrap db.PingContext in backoff.Retry
   - If all retries fail, close db and return error
   - Log at Debug level for each retry attempt (use slog)

4. Signature becomes: `InitDB(ctx context.Context, dbPath string, maxOpenConns, maxIdleConns int) (*sql.DB, error)`

The retry logic uses the same backoff library as Phase 1 HTTP retries for consistency. Use backoff.WithMaxRetries(backoff.NewExponentialBackOff(), 3) pattern.

Import "log/slog" for logging retry attempts at Debug level.
  </action>
  <verify>
Run `go build ./...` - should compile without errors.
Grep for "db.Ping" in init.go to confirm validation exists.
Grep for "SetMaxOpenConns" in init.go to confirm pool config exists.
  </verify>
  <done>
InitDB validates connection with db.Ping() using 3 retries with exponential backoff. Pool limits are configured via SetMaxOpenConns and SetMaxIdleConns. Function signature updated to accept context and pool config.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update InitDB call site in initializeServices</name>
  <files>cmd/seedbox_downloader/main.go</files>
  <action>
Update the InitDB call in initializeServices to pass the new parameters:

```go
database, err := sqlite.InitDB(ctx, cfg.DBPath, cfg.DBMaxOpenConns, cfg.DBMaxIdleConns)
```

The context is already available as a parameter to initializeServices. This wires the pool configuration from environment variables through to the database initialization.
  </action>
  <verify>
Run `go build ./...` - should compile without errors.
Run `go vet ./...` - should pass with no issues.
  </verify>
  <done>
InitDB is called with context and pool configuration from config struct. Application compiles and passes vet.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` compiles successfully
2. `go vet ./...` passes with no issues
3. `grep -n "db.Ping" internal/storage/sqlite/init.go` shows ping validation
4. `grep -n "SetMaxOpenConns" internal/storage/sqlite/init.go` shows pool configuration
5. `grep -n "DB_MAX_OPEN_CONNS" cmd/seedbox_downloader/main.go` shows env var config
</verification>

<success_criteria>
- Database initialization includes db.Ping() with 3 retries using exponential backoff
- Connection pool is configured with SetMaxOpenConns and SetMaxIdleConns
- Pool limits are configurable via DB_MAX_OPEN_CONNS and DB_MAX_IDLE_CONNS environment variables
- Application exits with clear error if database unreachable after retries
- Code compiles and passes vet
</success_criteria>

<output>
After completion, create `.planning/phases/03-operational-hygiene/03-01-SUMMARY.md`
</output>
