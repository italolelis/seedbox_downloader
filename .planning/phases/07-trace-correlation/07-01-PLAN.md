---
phase: 07-trace-correlation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/logctx/trace_handler.go
  - internal/logctx/trace_handler_test.go
  - cmd/seedbox_downloader/main.go
autonomous: true

must_haves:
  truths:
    - "Log entries include trace_id when OpenTelemetry span is active"
    - "Log entries include span_id when within an active span"
    - "JSON output format is preserved (no change to log structure except new fields)"
    - "Logs without trace context have no trace_id field (not empty string)"
  artifacts:
    - path: "internal/logctx/trace_handler.go"
      provides: "TraceHandler slog.Handler wrapper"
      exports: ["TraceHandler", "NewTraceHandler"]
      min_lines: 40
    - path: "internal/logctx/trace_handler_test.go"
      provides: "Unit tests for TraceHandler"
      min_lines: 50
    - path: "cmd/seedbox_downloader/main.go"
      provides: "Logger initialization with TraceHandler"
      contains: "NewTraceHandler"
  key_links:
    - from: "cmd/seedbox_downloader/main.go"
      to: "internal/logctx/trace_handler.go"
      via: "NewTraceHandler wrapping JSONHandler"
      pattern: "logctx\\.NewTraceHandler"
    - from: "internal/logctx/trace_handler.go"
      to: "go.opentelemetry.io/otel/trace"
      via: "trace.SpanFromContext"
      pattern: "trace\\.SpanFromContext"
---

<objective>
Create TraceHandler slog.Handler wrapper that injects trace_id and span_id into log entries, and integrate it into logger initialization.

Purpose: Enable automatic trace correlation in all log entries when OpenTelemetry tracing is active. This is the foundation for requirements TRACE-01 through TRACE-03.

Output: TraceHandler wrapper with tests, integrated into main.go logger setup.
</objective>

<execution_context>
@/Users/italovietro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/italovietro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-trace-correlation/07-RESEARCH.md

@internal/logctx/logctx.go
@cmd/seedbox_downloader/main.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TraceHandler wrapper</name>
  <files>internal/logctx/trace_handler.go, internal/logctx/trace_handler_test.go</files>
  <action>
Create a new file `internal/logctx/trace_handler.go` implementing `slog.Handler` interface:

1. Define `TraceHandler` struct that wraps an inner `slog.Handler`
2. Implement `NewTraceHandler(h slog.Handler) *TraceHandler` constructor with nil check (panic if nil)
3. Implement `Enabled(ctx context.Context, level slog.Level) bool` - delegate to inner handler
4. Implement `Handle(ctx context.Context, r slog.Record) error`:
   - Extract span from context using `trace.SpanFromContext(ctx)`
   - If `span.SpanContext().IsValid()`:
     - Add `slog.String("trace_id", span.SpanContext().TraceID().String())`
     - Add `slog.String("span_id", span.SpanContext().SpanID().String())`
   - If span is NOT valid, do NOT add trace_id/span_id fields (they should be absent, not empty)
   - Delegate to inner handler
5. Implement `WithAttrs(attrs []slog.Attr) slog.Handler` - return new TraceHandler wrapping inner.WithAttrs
6. Implement `WithGroup(name string) slog.Handler` - return new TraceHandler wrapping inner.WithGroup

Create test file `internal/logctx/trace_handler_test.go`:

1. Test that logs without span context have NO trace_id/span_id fields
2. Test that logs WITH valid span context include trace_id and span_id
3. Test that Enabled delegates correctly
4. Test that WithAttrs returns new TraceHandler
5. Test that WithGroup returns new TraceHandler
6. Test nil handler panics

Use `go.opentelemetry.io/otel/trace` for span extraction. Do NOT use the otelslog bridge (it sends logs to OTLP collectors, breaking JSON stdout requirement TRACE-03).
  </action>
  <verify>
```bash
go test -v ./internal/logctx/... -run TestTrace
```
All tests pass.
  </verify>
  <done>
TraceHandler implements slog.Handler, injects trace_id/span_id when span is valid, omits them when not valid, and all tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate TraceHandler into logger initialization</name>
  <files>cmd/seedbox_downloader/main.go</files>
  <action>
Modify `initializeConfig()` function in `cmd/seedbox_downloader/main.go`:

1. Change logger creation from:
```go
logger := slog.New(slog.NewJSONHandler(os.Stdout, &slog.HandlerOptions{Level: cfg.LogLevel}))
```

To:
```go
jsonHandler := slog.NewJSONHandler(os.Stdout, &slog.HandlerOptions{Level: cfg.LogLevel})
traceHandler := logctx.NewTraceHandler(jsonHandler)
logger := slog.New(traceHandler)
```

2. Ensure the import for `logctx` is present (should already be there)

This preserves the existing JSON output format while adding trace correlation capability.

The handler chain is: TraceHandler -> JSONHandler -> stdout
  </action>
  <verify>
```bash
go build -o /dev/null ./cmd/seedbox_downloader && echo "Build successful"
```
Build succeeds with no errors.
  </verify>
  <done>
Logger initialization uses TraceHandler wrapping JSONHandler. Application builds successfully.
  </done>
</task>

</tasks>

<verification>
1. `go test ./internal/logctx/...` passes all tests
2. `go build ./cmd/seedbox_downloader` succeeds
3. TraceHandler correctly extracts trace context from span
4. JSON output format preserved (no structural changes except optional trace_id/span_id fields)
</verification>

<success_criteria>
- TraceHandler exists at internal/logctx/trace_handler.go with full slog.Handler implementation
- Tests exist at internal/logctx/trace_handler_test.go covering span/no-span cases
- main.go uses TraceHandler wrapping JSONHandler
- Application compiles and tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-trace-correlation/07-01-SUMMARY.md`
</output>
