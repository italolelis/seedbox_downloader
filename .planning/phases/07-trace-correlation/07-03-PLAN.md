---
phase: 07-trace-correlation
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - internal/dc/deluge/client.go
  - internal/dc/putio/client.go
  - internal/http/rest/transmission.go
  - internal/telemetry/telemetry.go
autonomous: true

must_haves:
  truths:
    - "All logging calls in deluge/client.go use context-aware methods"
    - "All logging calls in putio/client.go use context-aware methods"
    - "All logging calls in transmission.go use context-aware methods"
    - "All HTTP handler logging has trace correlation"
  artifacts:
    - path: "internal/dc/deluge/client.go"
      provides: "Context-aware logging in Deluge client"
      contains: "InfoContext"
    - path: "internal/dc/putio/client.go"
      provides: "Context-aware logging in Put.io client"
      contains: "InfoContext"
    - path: "internal/http/rest/transmission.go"
      provides: "Context-aware logging in HTTP handlers"
      contains: "InfoContext"
  key_links:
    - from: "internal/http/rest/transmission.go"
      to: "slog context methods"
      via: "InfoContext/DebugContext/ErrorContext with r.Context()"
      pattern: "\\.(Info|Debug|Warn|Error)Context\\(ctx"
---

<objective>
Migrate client components (deluge, putio, transmission) from non-context logging methods to context-aware methods.

Purpose: Enable trace correlation in all external API interactions. This is critical for debugging request flows through Put.io/Deluge and the Transmission-compatible API.

Output: All logging calls in client files use *Context methods.
</objective>

<execution_context>
@/Users/italovietro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/italovietro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-trace-correlation/07-RESEARCH.md
@.planning/phases/07-trace-correlation/07-01-SUMMARY.md

@internal/dc/deluge/client.go
@internal/dc/putio/client.go
@internal/http/rest/transmission.go
@internal/telemetry/telemetry.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate deluge/client.go to context-aware logging</name>
  <files>internal/dc/deluge/client.go</files>
  <action>
Migrate ALL logging calls in `internal/dc/deluge/client.go`:

**Authenticate function (lines ~76-150):**
- Line 88: `logger.Error("failed to marshal payload"...)` -> `logger.ErrorContext(ctx, "failed to marshal payload"...)`
- Line 93: `logger.Info("authenticating with deluge"...)` -> `logger.InfoContext(ctx, "authenticating with deluge"...)`
- Line 98: `logger.Error("request error"...)` -> `logger.ErrorContext(ctx, "request error"...)`
- Line 109: `logger.Error("HTTP error"...)` -> `logger.ErrorContext(ctx, "HTTP error"...)`
- Line 117: `logger.Error("non-200 response"...)` -> `logger.ErrorContext(ctx, "non-200 response"...)`
- Line 136: `logger.Error("decode error"...)` -> `logger.ErrorContext(ctx, "decode error"...)`
- Line 142: `logger.Error("login failed"...)` -> `logger.ErrorContext(ctx, "login failed"...)`
- Line 147: `logger.Debug("authenticated with deluge")` -> `logger.DebugContext(ctx, "authenticated with deluge")`

**GrabFile function (lines ~188-224):**
- Line 194: `logger.Error("failed to create HTTP request"...)` -> `logger.ErrorContext(ctx, "failed to create HTTP request"...)`
- Line 210: `logger.Error("failed to download file"...)` -> `logger.ErrorContext(ctx, "failed to download file"...)`
- Line 216: `logger.Error("failed to download file, bad status"...)` -> `logger.ErrorContext(ctx, "failed to download file, bad status"...)`

**getTaggedTorrentsRaw function (lines ~227-293):**
- Line 240: `logger.Error("failed to create request"...)` -> `logger.ErrorContext(ctx, "failed to create request"...)`
- Line 253: `logger.Error("request execution failed"...)` -> `logger.ErrorContext(ctx, "request execution failed"...)`
- Line 261: `logger.Error("non-200 response"...)` -> `logger.ErrorContext(ctx, "non-200 response"...)`
- Line 269: `logger.Error("decode error"...)` -> `logger.ErrorContext(ctx, "decode error"...)`
- Line 275: `logger.Error("API error"...)` -> `logger.ErrorContext(ctx, "API error"...)`
- Line 290: `logger.Debug("found torrents to download"...)` -> `logger.DebugContext(ctx, "found torrents to download"...)`

All these functions receive `ctx context.Context` as parameter, so context is available.
  </action>
  <verify>
```bash
grep -c "\.Info\(\"" internal/dc/deluge/client.go || echo "0"
grep -c "\.InfoContext\(ctx" internal/dc/deluge/client.go
go build ./internal/dc/deluge/...
```
Zero non-context calls, build succeeds.
  </verify>
  <done>
All logging calls in deluge/client.go use context-aware methods.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate putio/client.go to context-aware logging</name>
  <files>internal/dc/putio/client.go</files>
  <action>
Migrate ALL logging calls in `internal/dc/putio/client.go`:

**GetTaggedTorrents function (lines ~39-109):**
- Line 44: `logger.Error("failed to get transfers"...)` -> `logger.ErrorContext(ctx, "failed to get transfers"...)`
- Line 53: `logger.Debug("skipping transfer because it's not a downloadable transfer"...)` -> `logger.DebugContext(ctx, "skipping transfer because it's not a downloadable transfer"...)`
- Line 60: `logger.Error("failed to get file"...)` -> `logger.ErrorContext(ctx, "failed to get file"...)`
- Line 67: `logger.Error("failed to get parent file"...)` -> `logger.ErrorContext(ctx, "failed to get parent file"...)`
- Line 73: `logger.Debug("skipping file"...)` -> `logger.DebugContext(ctx, "skipping file"...)`
- Line 106: `logger.Debug("found torrents to download"...)` -> `logger.DebugContext(ctx, "found torrents to download"...)`

**GrabFile function (lines ~111-130):**
- Line 117: `logger.Error("failed to get file download url"...)` -> `logger.ErrorContext(ctx, "failed to get file download url"...)`
- Line 124: `logger.Error("failed to get file"...)` -> `logger.ErrorContext(ctx, "failed to get file"...)`

**Authenticate function (lines ~132-147):**
- Line 135: `logger.Info("authenticating with Put.io")` -> `logger.InfoContext(ctx, "authenticating with Put.io")`
- Line 139: `logger.Error("failed to get account info"...)` -> `logger.ErrorContext(ctx, "failed to get account info"...)`
- Line 144: `logger.Info("authenticated with Put.io"...)` -> `logger.InfoContext(ctx, "authenticated with Put.io"...)`

**AddTransfer function (lines ~163-199):**
- Line 177: `logger.Info("adding transfer to Put.io"...)` -> `logger.InfoContext(ctx, "adding transfer to Put.io"...)`
- Line 184: `logger.Info("transfer added to Put.io"...)` -> `logger.InfoContext(ctx, "transfer added to Put.io"...)`

**AddTransferByBytes function (lines ~201-273):**
- Line 236: `logger.Info("uploading torrent file to Put.io"...)` -> `logger.InfoContext(ctx, "uploading torrent file to Put.io"...)`
- Line 256: `logger.Info("transfer created from torrent upload"...)` -> `logger.InfoContext(ctx, "transfer created from torrent upload"...)`

**RemoveTransfers function (lines ~275-310):**
- Line 279: `logger.Info("removing transfer from Put.io"...)` -> `logger.InfoContext(ctx, "removing transfer from Put.io"...)`
- Line 299: `logger.Info("deleting local file data"...)` -> `logger.InfoContext(ctx, "deleting local file data"...)`
- Line 305: `logger.Info("local file data deleted"...)` -> `logger.InfoContext(ctx, "local file data deleted"...)`

**getFilesRecursively function (lines ~344-390):**
- Line 380: `logger.Error("failed to get nested files"...)` -> `logger.ErrorContext(ctx, "failed to get nested files"...)`

All functions receive `ctx context.Context` as parameter.
  </action>
  <verify>
```bash
grep -c "\.Info\(\"" internal/dc/putio/client.go || echo "0"
grep -c "\.InfoContext\(ctx" internal/dc/putio/client.go
go build ./internal/dc/putio/...
```
Zero non-context calls, build succeeds.
  </verify>
  <done>
All logging calls in putio/client.go use context-aware methods.
  </done>
</task>

<task type="auto">
  <name>Task 3: Migrate transmission.go and telemetry.go to context-aware logging</name>
  <files>internal/http/rest/transmission.go, internal/telemetry/telemetry.go</files>
  <action>
**Part A: Migrate internal/http/rest/transmission.go**

This file uses `r.Context()` to get context. The pattern is already correct (logger from context), just need to add ctx parameter:

**HandleRPC function (lines ~145-228):**
- Line 147: `logger.Debug("received post rpc request")` -> `logger.DebugContext(ctx, "received post rpc request")`
  (Note: need to assign `ctx := r.Context()` before logger call, or use inline)
- Line 151: `logger.Error("failed to decode request"...)` -> `logger.ErrorContext(r.Context(), "failed to decode request"...)`
- Line 169: `logger.Error("failed to marshal config"...)` -> `logger.ErrorContext(r.Context(), "failed to marshal config"...)`
- Line 196: `logger.Error("unknown method"...)` -> `logger.ErrorContext(r.Context(), "unknown method"...)`
- Line 203: `logger.Error("failed to handle request"...)` -> `logger.ErrorContext(r.Context(), "failed to handle request"...)`
- Line 214: `logger.Error("failed to encode error response"...)` -> `logger.ErrorContext(r.Context(), "failed to encode error response"...)`
- Line 223: `logger.Error("failed to encode response"...)` -> `logger.ErrorContext(r.Context(), "failed to encode response"...)`

For HandleRPC, add `ctx := r.Context()` at the start after getting logger, then use `ctx` in all calls.

**handleTorrentAddByMetaInfo function (lines ~298-355):**
- Line 304: `logger.Error("failed to decode base64 metainfo"...)` -> `logger.ErrorContext(ctx, "failed to decode base64 metainfo"...)`
- Line 316: `logger.Debug("decoded metainfo"...)` -> `logger.DebugContext(ctx, "decoded metainfo"...)`
- Line 328: `logger.Error("bencode validation failed"...)` -> `logger.ErrorContext(ctx, "bencode validation failed"...)`
- Line 338: `logger.Debug("generated filename"...)` -> `logger.DebugContext(ctx, "generated filename"...)`
- Line 343: `logger.Error("failed to add transfer by bytes"...)` -> `logger.ErrorContext(ctx, "failed to add transfer by bytes"...)`
- Line 352: `logger.Info("transfer created from metainfo"...)` -> `logger.InfoContext(ctx, "transfer created from metainfo"...)`

**handleTorrentAdd function (lines ~357-407):**
- Line 366: `logger.Debug("processing torrent add request"...)` -> `logger.DebugContext(ctx, "processing torrent add request"...)`
- Line 373: `logger.Debug("processing torrent add request"...)` -> `logger.DebugContext(ctx, "processing torrent add request"...)`

**handleTorrentRemove function (lines ~409-420):**
- Line 411: `logger.Debug("received torrent remove request")` -> `logger.DebugContext(ctx, "received torrent remove request")`

**handleTorrentGet function (lines ~422-501):**
- Line 425: `logger.Debug("fetching torrents from download client")` -> `logger.DebugContext(ctx, "fetching torrents from download client")`
- Line 433: `logger.Debug("fetched torrents from download client"...)` -> `logger.DebugContext(ctx, "fetched torrents from download client"...)`
- Line 435: `logger.Debug("converting torrents to transmission format")` -> `logger.DebugContext(ctx, "converting torrents to transmission format")`
- Line 443: `logger.Error("failed to parse transfer ID"...)` -> `logger.ErrorContext(ctx, "failed to parse transfer ID"...)`
- Line 488: `logger.Debug("converted torrents to transmission format"...)` -> `logger.DebugContext(ctx, "converted torrents to transmission format"...)`

**Part B: Migrate internal/telemetry/telemetry.go**

There's one log call:
- Line 89: `slog.Info("Telemetry disabled - metrics and traces will not be collected")` -> `slog.InfoContext(ctx, "Telemetry disabled - metrics and traces will not be collected")`

Check if the `New` function receives context - it does (ctx is first parameter).
  </action>
  <verify>
```bash
grep -c "\.Info\(\"" internal/http/rest/transmission.go internal/telemetry/telemetry.go || echo "0"
grep -c "\.InfoContext\(" internal/http/rest/transmission.go internal/telemetry/telemetry.go
go build ./internal/http/rest/... ./internal/telemetry/...
```
Zero non-context calls, build succeeds.
  </verify>
  <done>
All logging calls in transmission.go and telemetry.go use context-aware methods.
  </done>
</task>

</tasks>

<verification>
1. `grep -E '\.(Info|Debug|Warn|Error)\("' internal/dc/deluge/client.go internal/dc/putio/client.go internal/http/rest/transmission.go internal/telemetry/telemetry.go` returns empty
2. `go build ./...` succeeds
3. `go test ./internal/dc/... ./internal/http/rest/...` passes
</verification>

<success_criteria>
- All logging calls in deluge/client.go, putio/client.go, transmission.go, telemetry.go use *Context methods
- No non-context logging methods remain in these files
- Application compiles and all tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-trace-correlation/07-03-SUMMARY.md`
</output>
