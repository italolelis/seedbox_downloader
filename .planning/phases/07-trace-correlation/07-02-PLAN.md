---
phase: 07-trace-correlation
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - internal/downloader/downloader.go
  - internal/transfer/transfer.go
  - cmd/seedbox_downloader/main.go
autonomous: true

must_haves:
  truths:
    - "All logging calls in downloader.go use context-aware methods"
    - "All logging calls in transfer.go use context-aware methods"
    - "All logging calls in main.go use context-aware methods"
    - "All goroutines propagate context to logging calls"
  artifacts:
    - path: "internal/downloader/downloader.go"
      provides: "Context-aware logging in downloader"
      contains: "InfoContext"
    - path: "internal/transfer/transfer.go"
      provides: "Context-aware logging in transfer orchestrator"
      contains: "InfoContext"
    - path: "cmd/seedbox_downloader/main.go"
      provides: "Context-aware logging in main"
      contains: "InfoContext"
  key_links:
    - from: "internal/downloader/downloader.go"
      to: "slog context methods"
      via: "InfoContext/DebugContext/ErrorContext calls"
      pattern: "\\.(Info|Debug|Warn|Error)Context\\(ctx"
    - from: "internal/transfer/transfer.go"
      to: "slog context methods"
      via: "InfoContext/DebugContext/ErrorContext calls"
      pattern: "\\.(Info|Debug|Warn|Error)Context\\(ctx"
---

<objective>
Migrate core components (downloader, transfer, main.go) from non-context logging methods to context-aware methods.

Purpose: Enable trace correlation in the core pipeline components. These are the highest-traffic code paths where trace correlation matters most.

Output: All logging calls in downloader.go, transfer.go, and main.go use *Context methods.
</objective>

<execution_context>
@/Users/italovietro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/italovietro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-trace-correlation/07-RESEARCH.md
@.planning/phases/07-trace-correlation/07-01-SUMMARY.md

@internal/downloader/downloader.go
@internal/transfer/transfer.go
@cmd/seedbox_downloader/main.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate downloader.go to context-aware logging</name>
  <files>internal/downloader/downloader.go</files>
  <action>
Migrate ALL logging calls in `internal/downloader/downloader.go` from non-context to context-aware methods.

The pattern for each change:
- `logger.Info(msg, args...)` -> `logger.InfoContext(ctx, msg, args...)`
- `logger.Debug(msg, args...)` -> `logger.DebugContext(ctx, msg, args...)`
- `logger.Error(msg, args...)` -> `logger.ErrorContext(ctx, msg, args...)`
- `logger.Warn(msg, args...)` -> `logger.WarnContext(ctx, msg, args...)`

Specific changes needed (by line reference from current code):

**WatchDownloads function (lines ~70-102):**
- Line 74: `logger.Info("watching downloads")` -> `logger.InfoContext(ctx, "watching downloads")`
- Line 80: `logger.Info("shutting down downloader")` -> `logger.InfoContext(ctx, "shutting down downloader")`
- Line 84: `logger.Debug("downloading transfer"...)` -> `logger.DebugContext(ctx, "downloading transfer"...)`
- Line 88: `logger.Error("failed to download transfer"...)` -> `logger.ErrorContext(ctx, "failed to download transfer"...)`
- Line 96: `logger.Info("downloads completed"...)` -> `logger.InfoContext(ctx, "downloads completed"...)`

**DownloadTransfer function (lines ~105-150):**
- Line 129: `logger.Debug("file already downloaded"...)` -> `logger.DebugContext(ctx, "file already downloaded"...)`
- Line 134: `logger.Error("failed to download file"...)` -> `logger.ErrorContext(ctx, "failed to download file"...)`

**DownloadFile function (lines ~152-182):**
- Line 179: `logger.Info("downloaded and saved file"...)` -> `logger.InfoContext(ctx, "downloaded and saved file"...)`

**WatchForImported function (lines ~184-230):**
- Line 187: `logger.Info("watching for imported transfers"...)` -> `logger.InfoContext(ctx, "watching for imported transfers"...)`
- Line 192: `logger.Error("watch imported panic"...)` -> `logger.ErrorContext(ctx, "watch imported panic"...)`
- Line 206: `logger.Info("watch imported shutdown"...)` -> `logger.InfoContext(ctx, "watch imported shutdown"...)`
- Line 214: `logger.Error("failed to check for imported transfer"...)` -> `logger.ErrorContext(ctx, "failed to check for imported transfer"...)`
- Line 220: `logger.Info("transfer imported, stopping watch"...)` -> `logger.InfoContext(ctx, "transfer imported, stopping watch"...)`

**WatchForSeeding function (lines ~232-279):**
- Line 235: `logger.Info("watching for seeding transfers"...)` -> `logger.InfoContext(ctx, "watching for seeding transfers"...)`
- Line 240: `logger.Error("watch seeding panic"...)` -> `logger.ErrorContext(ctx, "watch seeding panic"...)`
- Line 254: `logger.Info("watch seeding shutdown"...)` -> `logger.InfoContext(ctx, "watch seeding shutdown"...)`
- Line 261: `logger.Info("transfer stopped seeding"...)` -> `logger.InfoContext(ctx, "transfer stopped seeding"...)`
- Line 270: `logger.Error("failed to remove transfer"...)` -> `logger.ErrorContext(ctx, "failed to remove transfer"...)`

**checkForImported function (lines ~281-309):**
- Line 283: `logger.Debug("checking if transfer has been imported"...)` -> `logger.DebugContext(ctx, "checking if transfer has been imported"...)`
- Line 295: `logger.Info("transfer has been imported"...)` -> `logger.InfoContext(ctx, "transfer has been imported"...)`
- Line 301: `logger.Info("transfer removed"...)` -> `logger.InfoContext(ctx, "transfer removed"...)`

**ensureTargetDir function (lines ~311-320):**
This function takes `logger *slog.Logger` as parameter, not context. Change signature to accept context:
- Change signature from `func (d *Downloader) ensureTargetDir(targetPath string, logger *slog.Logger) error`
- To `func (d *Downloader) ensureTargetDir(ctx context.Context, targetPath string) error`
- Get logger inside: `logger := logctx.LoggerFromContext(ctx)`
- Line 314: `logger.Error("failed to create target directory"...)` -> `logger.ErrorContext(ctx, "failed to create target directory"...)`
- Update caller in DownloadFile to pass ctx instead of logger

**writeFile function (lines ~322-346):**
- Line 325: `logger.Info("downloading file"...)` -> `logger.InfoContext(ctx, "downloading file"...)`
- Line 330: `logger.Debug("download progress"...)` -> `logger.DebugContext(ctx, "download progress"...)`
- Line 336: `logger.Debug("download progress"...)` -> `logger.DebugContext(ctx, "download progress"...)`

IMPORTANT: Every function that logs must have access to `ctx`. Check that context is available where logging happens.
  </action>
  <verify>
```bash
grep -c "\.Info\(\"" internal/downloader/downloader.go && echo "Non-context Info calls found (should be 0)"
grep -c "\.InfoContext\(ctx" internal/downloader/downloader.go && echo "Context-aware Info calls"
go build ./internal/downloader/...
```
Should show 0 non-context calls and multiple context-aware calls. Build succeeds.
  </verify>
  <done>
All logging calls in downloader.go use context-aware methods (*Context). No non-context logging calls remain.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate transfer.go and main.go to context-aware logging</name>
  <files>internal/transfer/transfer.go, cmd/seedbox_downloader/main.go</files>
  <action>
**Part A: Migrate internal/transfer/transfer.go**

Migrate ALL logging calls:

**ProduceTransfers function (lines ~93-135):**
- Line 96: `logger.Info("checking unfinished transfers"...)` -> `logger.InfoContext(ctx, "checking unfinished transfers"...)`
- Line 102: `logger.Error("transfer orchestrator panic"...)` -> `logger.ErrorContext(ctx, "transfer orchestrator panic"...)`
- Line 109: `logger.Info("restarting transfer orchestrator after panic"...)` -> `logger.InfoContext(ctx, "restarting transfer orchestrator after panic"...)`
- Line 124: `logger.Info("transfer orchestrator shutdown"...)` -> `logger.InfoContext(ctx, "transfer orchestrator shutdown"...)`
- Line 130: `logger.Error("failed to watch transfers"...)` -> `logger.ErrorContext(ctx, "failed to watch transfers"...)`

**watchTransfers function (lines ~137-181):**
- Line 140: `logger.Info("watching transfers"...)` -> `logger.InfoContext(ctx, "watching transfers"...)`
- Line 147: `logger.Info("active transfers"...)` -> `logger.InfoContext(ctx, "active transfers"...)`
- Line 153: `transferLogger.Debug("skipping transfer because it's not available or not downloadable")` -> `transferLogger.DebugContext(ctx, "skipping transfer because it's not available or not downloadable")`
- Line 161: `transferLogger.Debug("skipping transfer because it's already downloaded")` -> `transferLogger.DebugContext(ctx, "skipping transfer because it's already downloaded")`
- Line 170: `transferLogger.Debug("skipping transfer because it's already claimed")` -> `transferLogger.DebugContext(ctx, "skipping transfer because it's already claimed")`
- Line 175: `transferLogger.Info("transfer ready for download")` -> `transferLogger.InfoContext(ctx, "transfer ready for download")`

**Part B: Migrate cmd/seedbox_downloader/main.go**

Migrate ALL logging calls:

**run function:**
- Line 101: `logger.Info("starting..."...)` -> `logger.InfoContext(ctx, "starting..."...)`
- Line 120: `logger.Info("waiting for downloads..."...)` -> `logger.InfoContext(ctx, "waiting for downloads..."...)`

**startServers function:**
- Line 227: `logger.Info("initializing API support"...)` -> `logger.InfoContext(ctx, "initializing API support"...)`

**runMainLoop function:**
- Line 245: `logger.Info("start shutdown")` -> `logger.InfoContext(ctx, "start shutdown")`
- Line 252: `logger.Error("failed to gracefully shutdown metrics server"...)` -> `logger.ErrorContext(ctx, "failed to gracefully shutdown metrics server"...)`
- Line 257: `logger.Error("failed to gracefully shutdown the server"...)` -> `logger.ErrorContext(ctx, "failed to gracefully shutdown the server"...)`

Note: In runMainLoop, context comes from the parent, but the shutdown logic uses `context.Background()`. For shutdown logging, use the original `ctx` before cancellation check. In the `ctx.Done()` case, create a fresh context or use Background since the original is cancelled.

**setupNotificationForDownloader function (lines ~269-351):**
All logging calls within the goroutine should use context-aware methods:
- Line 285: `logger.Error("notification loop panic"...)` -> `logger.ErrorContext(ctx, "notification loop panic"...)`
- Line 292: `logger.Info("restarting notification loop after panic"...)` -> `logger.InfoContext(ctx, "restarting notification loop after panic"...)`
- Line 303: `logger.Info("notification loop shutdown"...)` -> `logger.InfoContext(ctx, "notification loop shutdown"...)`
- Line 311: `logger.Error("failed to update transfer status"...)` -> `logger.ErrorContext(ctx, "failed to update transfer status"...)`
- Line 316: `logger.Warn("transfer download error"...)` -> `logger.WarnContext(ctx, "transfer download error"...)`
- Line 321: `logger.Error("failed to send notification"...)` -> `logger.ErrorContext(ctx, "failed to send notification"...)`
- Line 326: `logger.Error("failed to update transfer status"...)` -> `logger.ErrorContext(ctx, "failed to update transfer status"...)`
- Line 333: `logger.Info("transfer download finished"...)` -> `logger.InfoContext(ctx, "transfer download finished"...)`
- Line 338: `logger.Error("failed to send notification"...)` -> `logger.ErrorContext(ctx, "failed to send notification"...)`
- Line 346: `logger.Error("failed to send notification"...)` -> `logger.ErrorContext(ctx, "failed to send notification"...)`
  </action>
  <verify>
```bash
# Check for non-context calls
grep -c "\.Info\(\"" internal/transfer/transfer.go cmd/seedbox_downloader/main.go 2>/dev/null || true
grep -c "\.InfoContext\(ctx" internal/transfer/transfer.go cmd/seedbox_downloader/main.go
go build ./cmd/seedbox_downloader
```
Should show minimal/zero non-context calls and build succeeds.
  </verify>
  <done>
All logging calls in transfer.go and main.go use context-aware methods. Build succeeds.
  </done>
</task>

</tasks>

<verification>
1. `grep -E '\.(Info|Debug|Warn|Error)\("' internal/downloader/downloader.go internal/transfer/transfer.go cmd/seedbox_downloader/main.go` returns empty (no non-context calls)
2. `go build ./cmd/seedbox_downloader` succeeds
3. `go test ./internal/downloader/... ./internal/transfer/...` passes
</verification>

<success_criteria>
- All logging calls in downloader.go, transfer.go, main.go use *Context methods
- No non-context logging methods remain in these files (except possibly in callbacks where context isn't available - document if so)
- Application compiles and tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-trace-correlation/07-02-SUMMARY.md`
</output>
