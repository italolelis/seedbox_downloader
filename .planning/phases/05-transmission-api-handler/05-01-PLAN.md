---
phase: 05-transmission-api-handler
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - go.mod
  - go.sum
  - internal/http/rest/transmission.go
autonomous: true

must_haves:
  truths:
    - "MetaInfo field is detected and prioritized over FileName when both present"
    - "Base64-encoded .torrent content is decoded correctly using StdEncoding"
    - "Invalid base64 content returns InvalidContentError with specific reason"
    - "Invalid bencode structure returns InvalidContentError with specific reason"
    - "Valid .torrent content is uploaded to Put.io via AddTransferByBytes"
    - "Existing magnet link behavior (FileName only) works identically"
  artifacts:
    - path: "internal/http/rest/transmission.go"
      provides: "MetaInfo handling in handleTorrentAdd"
      contains: "handleTorrentAddByMetaInfo"
    - path: "internal/http/rest/transmission.go"
      provides: "Bencode validation function"
      contains: "validateBencodeStructure"
    - path: "internal/http/rest/transmission.go"
      provides: "Filename generation from torrent content"
      contains: "generateTorrentFilename"
    - path: "go.mod"
      provides: "Bencode library dependency"
      contains: "github.com/zeebo/bencode"
  key_links:
    - from: "handleTorrentAdd"
      to: "handleTorrentAddByMetaInfo"
      via: "MetaInfo != empty check"
      pattern: "req\\.Arguments\\.MetaInfo\\s*!=\\s*\"\""
    - from: "handleTorrentAddByMetaInfo"
      to: "AddTransferByBytes"
      via: "Put.io client method call"
      pattern: "h\\.dc\\.AddTransferByBytes"
    - from: "handleTorrentAddByMetaInfo"
      to: "validateBencodeStructure"
      via: "function call before upload"
      pattern: "validateBencodeStructure\\(torrentBytes\\)"
---

<objective>
Extend Transmission API handler to accept and process .torrent file content via MetaInfo field

Purpose: Enable Sonarr/Radarr to add torrents from private trackers by uploading .torrent file content instead of magnet links. This is the core functionality for v1.1 milestone.

Output:
- Refactored handleTorrentAdd method with MetaInfo priority
- Helper functions for base64 decoding, bencode validation, and filename generation
- Bencode library dependency added to project
</objective>

<execution_context>
@/Users/italovietro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/italovietro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-transmission-api-handler/05-RESEARCH.md
@.planning/phases/04-put-io-client-extension/04-01-SUMMARY.md
@.planning/phases/04-put-io-client-extension/04-02-SUMMARY.md
@internal/http/rest/transmission.go
@internal/transfer/errors.go
@internal/dc/putio/client.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add bencode library dependency</name>
  <files>go.mod, go.sum</files>
  <action>
Add github.com/zeebo/bencode as a dependency.

Run:
```bash
go get github.com/zeebo/bencode
```

This library is chosen for:
- JSON-like API familiarity (DecodeBytes similar to json.Unmarshal)
- Well-maintained and widely used in Go ecosystem
- Handles all bencode edge cases (dictionary ordering, nested structures)
  </action>
  <verify>
Run `go mod tidy && go build ./...` to confirm dependency is added and builds successfully.
Check go.mod contains `github.com/zeebo/bencode`.
  </verify>
  <done>
Bencode library available for import in transmission.go.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor handleTorrentAdd with MetaInfo support</name>
  <files>internal/http/rest/transmission.go</files>
  <action>
Refactor the existing `handleTorrentAdd` method to support both MetaInfo and FileName fields.

**Add imports at top of file:**
```go
import (
    "encoding/base64"
    "github.com/zeebo/bencode"
    "github.com/italolelis/seedbox_downloader/internal/transfer"
)
```

**Add constants for size validation:**
```go
const maxTorrentSize = 10 * 1024 * 1024 // 10MB - matches Phase 4 limit
```

**Add helper functions (add these BEFORE handleTorrentAdd):**

1. `validateBencodeStructure(data []byte) error` - Validates bencode structure and required torrent fields:
   - Decode bytes as bencode to interface{}
   - Verify root is a dictionary (map[string]interface{})
   - Verify required 'info' field exists
   - Return InvalidContentError with specific reason on failure

2. `generateTorrentFilename(torrentBytes []byte) string` - Generates unique .torrent filename:
   - SHA1 hash of torrent content
   - Use first 16 chars of hex-encoded hash
   - Append ".torrent" extension

3. `handleTorrentAddByMetaInfo(ctx context.Context, req *TransmissionRequest) (*transfer.Transfer, error)` - Process MetaInfo field:
   - Decode base64 using `base64.StdEncoding.DecodeString()` (NOT URLEncoding or RawStdEncoding)
   - Check decoded size against maxTorrentSize BEFORE bencode validation
   - Call validateBencodeStructure()
   - Generate filename using generateTorrentFilename()
   - Call h.dc.AddTransferByBytes() with decoded bytes, generated filename, and h.label
   - Return InvalidContentError for base64 decode failures, size limit, or bencode validation failures

**Refactor handleTorrentAdd to:**

1. Check MetaInfo field FIRST (priority per API-06):
   ```go
   if req.Arguments.MetaInfo != "" {
       logger.Debug("received torrent add with metainfo field")
       torrent, err = h.handleTorrentAddByMetaInfo(ctx, req)
   } else if req.Arguments.FileName != "" {
       // Existing magnet link handling
   } else {
       return nil, fmt.Errorf("either metainfo or filename must be provided")
   }
   ```

2. Keep existing magnet link logic for backward compatibility (API-05):
   - Use AddTransferByURL (not the deprecated AddTransfer) for magnet links
   - Preserve exact same behavior when only FileName is present

3. Update response format to match Transmission spec with torrent-added:
   ```go
   jsonTorrent, err := json.Marshal(map[string]interface{}{
       "torrent-added": map[string]interface{}{
           "id":         torrent.ID,
           "name":       torrent.Name,
           "hashString": torrent.ID,
       },
   })
   ```

**Important implementation details from research:**
- Use `base64.StdEncoding` NOT `base64.URLEncoding` (Transmission spec requirement)
- Check size BEFORE bencode validation to prevent memory exhaustion on malformed large uploads
- Use transfer.InvalidContentError for validation failures (from Phase 4)
- Log torrent type (metainfo vs magnet) at Debug level
  </action>
  <verify>
Run:
```bash
go build ./...
go vet ./internal/http/rest/...
```

Verify:
- No compilation errors
- No vet warnings
- handleTorrentAdd checks MetaInfo before FileName
- validateBencodeStructure and generateTorrentFilename functions exist
- AddTransferByBytes is called for MetaInfo path
  </verify>
  <done>
- handleTorrentAdd prioritizes MetaInfo over FileName (API-01, API-06)
- Base64 decoding uses StdEncoding (API-02)
- Bencode validation catches malformed content (API-03)
- Magnet link behavior unchanged (API-05)
- Size limit prevents memory exhaustion
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Build verification:**
   ```bash
   go build ./...
   go vet ./...
   ```

2. **Function existence check:**
   ```bash
   grep -n "func validateBencodeStructure" internal/http/rest/transmission.go
   grep -n "func generateTorrentFilename" internal/http/rest/transmission.go
   grep -n "func.*handleTorrentAddByMetaInfo" internal/http/rest/transmission.go
   ```

3. **MetaInfo priority verification:**
   ```bash
   grep -A5 "func.*handleTorrentAdd\(" internal/http/rest/transmission.go | grep -q "MetaInfo"
   ```

4. **Bencode library import:**
   ```bash
   grep "zeebo/bencode" internal/http/rest/transmission.go
   grep "zeebo/bencode" go.mod
   ```
</verification>

<success_criteria>
- [ ] `go build ./...` succeeds
- [ ] `go vet ./...` reports no issues
- [ ] handleTorrentAdd checks MetaInfo field before FileName field
- [ ] validateBencodeStructure function validates torrent structure
- [ ] generateTorrentFilename function creates hash-based .torrent filename
- [ ] handleTorrentAddByMetaInfo handles the complete MetaInfo processing flow
- [ ] base64.StdEncoding is used (not URLEncoding)
- [ ] Size validation occurs before bencode parsing
- [ ] transfer.InvalidContentError is used for validation failures
</success_criteria>

<output>
After completion, create `.planning/phases/05-transmission-api-handler/05-01-SUMMARY.md`
</output>
