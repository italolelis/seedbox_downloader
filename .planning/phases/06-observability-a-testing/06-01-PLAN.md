---
phase: 06-observability-a-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/telemetry/telemetry.go
  - internal/http/rest/transmission.go
  - cmd/seedbox_downloader/main.go
autonomous: true

must_haves:
  truths:
    - "Every torrent-add request logs torrent_type field (magnet or metainfo)"
    - "OpenTelemetry counter tracks torrent type distribution"
    - "Error logs include error_type field (invalid_base64, invalid_bencode, api_error)"
  artifacts:
    - path: "internal/telemetry/telemetry.go"
      provides: "torrentTypeCounter metric and RecordTorrentType method"
      contains: "torrents.type.total"
    - path: "internal/http/rest/transmission.go"
      provides: "Structured logging with torrent_type and error_type fields"
      contains: "torrent_type"
  key_links:
    - from: "internal/http/rest/transmission.go"
      to: "internal/telemetry/telemetry.go"
      via: "RecordTorrentType method call"
      pattern: "RecordTorrentType.*ctx.*metainfo|magnet"
---

<objective>
Add structured logging and OpenTelemetry metrics for .torrent file handling observability.

Purpose: Enable production visibility into torrent type distribution and error categorization for debugging and monitoring dashboards.
Output: Telemetry counter for torrent types and structured log fields for error categorization.
</objective>

<execution_context>
@/Users/italovietro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/italovietro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-observability-a-testing/06-RESEARCH.md
@internal/telemetry/telemetry.go
@internal/http/rest/transmission.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add torrent type counter to telemetry package</name>
  <files>internal/telemetry/telemetry.go</files>
  <action>
Extend the Telemetry struct and initialization:

1. Add torrentTypeCounter field to Telemetry struct:
```go
torrentTypeCounter metric.Int64Counter
```

2. In initializeBusinessMetrics(), create the counter after existing metrics:
```go
t.torrentTypeCounter, err = t.meter.Int64Counter(
    "torrents.type.total",
    metric.WithDescription("Total torrents added by type (magnet vs metainfo)"),
    metric.WithUnit("{torrent}"),
)
if err != nil {
    return fmt.Errorf("failed to create torrents.type.total counter: %w", err)
}
```

3. Add public RecordTorrentType method:
```go
// RecordTorrentType records a torrent add operation by type.
func (t *Telemetry) RecordTorrentType(ctx context.Context, torrentType string) {
    if t.torrentTypeCounter != nil {
        t.torrentTypeCounter.Add(ctx, 1,
            metric.WithAttributes(
                attribute.String("torrent_type", torrentType),
            ),
        )
    }
}
```

Note: Only two possible values for torrent_type attribute: "magnet" and "metainfo" (cardinality = 2).
  </action>
  <verify>
Run `go build ./...` - should compile without errors.
Run `grep -n "torrents.type.total" internal/telemetry/telemetry.go` - should show counter creation.
Run `grep -n "RecordTorrentType" internal/telemetry/telemetry.go` - should show public method.
  </verify>
  <done>
Telemetry package has torrentTypeCounter metric with RecordTorrentType method that accepts "magnet" or "metainfo" as torrent_type attribute.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add telemetry field, structured logging to TransmissionHandler, and update main.go</name>
  <files>internal/http/rest/transmission.go, cmd/seedbox_downloader/main.go</files>
  <action>
This task modifies both transmission.go and main.go together to avoid intermediate compilation failure.

**Part A: Extend TransmissionHandler (transmission.go)**

1. Add telemetry field to TransmissionHandler struct:
```go
type TransmissionHandler struct {
    username    string
    password    string
    dc          *putio.Client
    label       string
    downloadDir string
    telemetry   *telemetry.Telemetry  // Add this field
}
```

2. Update NewTransmissionHandler to accept telemetry parameter:
```go
func NewTransmissionHandler(username, password string, dc *putio.Client, label string, downloadDir string, t *telemetry.Telemetry) *TransmissionHandler {
    return &TransmissionHandler{
        username:    username,
        password:    password,
        dc:          dc,
        label:       label,
        downloadDir: downloadDir,
        telemetry:   t,
    }
}
```

3. Add import for telemetry package at top of file:
```go
"github.com/italolelis/seedbox_downloader/internal/telemetry"
```

4. In handleTorrentAdd, add logging and metric recording after detecting torrent type:
```go
// Requirement API-06: Prioritize MetaInfo when both present
if req.Arguments.MetaInfo != "" {
    // Requirement API-01: Detect MetaInfo field
    logger.Debug("processing torrent add request", "torrent_type", "metainfo")  // OBS-01
    if h.telemetry != nil {
        h.telemetry.RecordTorrentType(ctx, "metainfo")  // OBS-02
    }
    torrent, err = h.handleTorrentAddByMetaInfo(ctx, req)
} else if req.Arguments.FileName != "" {
    // Requirement API-05: Maintain backward compatibility
    logger.Debug("processing torrent add request", "torrent_type", "magnet")  // OBS-01
    if h.telemetry != nil {
        h.telemetry.RecordTorrentType(ctx, "magnet")  // OBS-02
    }
    magnetLink := req.Arguments.FileName
    // ... rest of existing code
}
```

5. In handleTorrentAddByMetaInfo, add error_type to error logging (OBS-03):
```go
// Base64 decode error:
if err != nil {
    logger.Error("failed to decode base64 metainfo",
        "err", err,
        "error_type", "invalid_base64",
        "metainfo_length", len(req.Arguments.MetaInfo),
    )
    // ... existing return
}

// Bencode validation error (after validateBencodeStructure call):
if err := validateBencodeStructure(torrentBytes); err != nil {
    logger.Error("bencode validation failed",
        "err", err,
        "error_type", "invalid_bencode",
        "size_bytes", len(torrentBytes),
    )
    return nil, err
}

// Put.io API error (after AddTransferByBytes call):
if err != nil {
    logger.Error("failed to add transfer by bytes",
        "err", err,
        "error_type", "api_error",
        "filename", filename,
        "size_bytes", len(torrentBytes),
    )
    return nil, err
}
```

**Part B: Update main.go**

Find the NewTransmissionHandler call in main.go and add the telemetry parameter.

The call should change from:
```go
NewTransmissionHandler(username, password, dc, label, downloadDir)
```

To:
```go
NewTransmissionHandler(username, password, dc, label, downloadDir, t)
```

Where `t` is the existing *telemetry.Telemetry instance (already created in main.go for other instrumentation).

Search for the variable name used for telemetry in main.go and use that same variable.

Note: The telemetry parameter can be nil (for backward compatibility in tests). Always check `if h.telemetry != nil` before calling methods.
  </action>
  <verify>
Run `go build ./...` - should compile without errors.
Run `go vet ./...` - should pass with no warnings.
  </verify>
  <done>
TransmissionHandler has telemetry field, logs include torrent_type and error_type structured fields, and main.go passes telemetry to handler.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` compiles without errors
2. `go vet ./...` passes without warnings
3. `grep -n "torrent_type" internal/http/rest/transmission.go` shows structured log fields
4. `grep -n "error_type" internal/http/rest/transmission.go` shows error categorization
5. `grep -n "RecordTorrentType" internal/telemetry/telemetry.go` shows public method
6. `grep -n "torrents.type.total" internal/telemetry/telemetry.go` shows counter metric
</verification>

<success_criteria>
- Telemetry package has torrentTypeCounter with RecordTorrentType method
- TransmissionHandler logs torrent_type on every torrent-add request (OBS-01)
- TransmissionHandler records torrent type metric (OBS-02)
- Error logs include error_type field for categorization (OBS-03)
- Application compiles and passes vet checks
</success_criteria>

<output>
After completion, create `.planning/phases/06-observability-a-testing/06-01-SUMMARY.md`
</output>
