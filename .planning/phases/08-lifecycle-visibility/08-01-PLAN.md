---
phase: 08-lifecycle-visibility
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cmd/seedbox_downloader/main.go
autonomous: true

must_haves:
  truths:
    - "Startup logs show config -> telemetry -> database -> clients -> server phases in order"
    - "Each initialization phase logs 'initializing X' at start and 'X ready' at completion"
    - "Application logs 'service ready' with port and target_label after all components initialize"
    - "Configuration logs include label, polling interval, download directory (not secrets)"
  artifacts:
    - path: "cmd/seedbox_downloader/main.go"
      provides: "Phased startup logging with component ready messages"
      contains: "service ready"
  key_links:
    - from: "run() function"
      to: "initializeTelemetry, initializeServices, startServers"
      via: "phase logging before/after each init call"
      pattern: 'logger\.InfoContext\(ctx, "initializing'
---

<objective>
Add comprehensive startup lifecycle logging to main.go

Purpose: Operators need visibility into what the application is doing during startup. Clear phase logging helps diagnose initialization issues and verify correct configuration.

Output: main.go with phased startup logging showing config -> telemetry -> database -> clients -> server initialization, component "ready" messages, configuration value logging (secrets filtered), and final "service ready" message.
</objective>

<execution_context>
@/Users/italovietro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/italovietro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-lifecycle-visibility/08-RESEARCH.md
@cmd/seedbox_downloader/main.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add phased startup logging with configuration values</name>
  <files>cmd/seedbox_downloader/main.go</files>
  <action>
Update the run() function and initialization helpers to add phased startup logging:

1. In run() function, add phase logging around each initialization step:
   - Before initializeConfig: No log (logger not available yet)
   - After initializeConfig: Log "configuration loaded" with safe config values:
     - log_level, version, target_label, download_dir, polling_interval, cleanup_interval,
     - keep_downloaded_for, max_parallel, download_client, db_path, bind_address, telemetry_enabled
     - NEVER log: DelugePassword, PutioToken, DiscordWebhookURL, Transmission.Username/Password
   - Before initializeTelemetry: Log "initializing telemetry"
   - After initializeTelemetry: Log "telemetry ready" with service_name, otel_enabled
   - Before initializeServices: Log "initializing services" (covers database + clients)
   - Modify initializeServices to add internal phase logs:
     - "initializing database" before sqlite.InitDB
     - "database ready" after successful init with db_path, max_open_conns, max_idle_conns
     - "initializing download client" before buildDownloadClient
     - "download client ready" after successful auth with client_type
   - Before startServers: Log "starting HTTP server"
   - After startServers: Log "server ready" with bind_address

2. Replace the "waiting for downloads..." log with a proper "service ready" log at end of run():
   ```go
   logger.InfoContext(ctx, "service ready",
       "bind_address", cfg.Web.BindAddress,
       "target_label", cfg.TargetLabel,
       "version", version)
   ```

The logging pattern should be consistent:
- "initializing X" at phase start
- "X ready" at phase completion with relevant context fields
- Use component-specific context: db_path for database, client_type for download client, bind_address for server

Do NOT modify runMainLoop or shutdown logging (that's Plan 02).
  </action>
  <verify>
Run `go build ./cmd/seedbox_downloader` to verify no syntax errors.
Run `grep -n "initializing\|ready" cmd/seedbox_downloader/main.go` to verify phase logging exists.
Verify "service ready" message exists with bind_address, target_label, version fields.
Verify no secrets appear in logging (grep for Password, Token, Webhook should not appear in log calls).
  </verify>
  <done>
Startup logs show ordered phases: configuration loaded -> initializing telemetry -> telemetry ready -> initializing services -> database ready -> download client ready -> starting HTTP server -> server ready -> service ready. Configuration logged with safe values only.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify startup log ordering with manual test</name>
  <files>cmd/seedbox_downloader/main.go</files>
  <action>
Create a simple test that verifies log messages appear in correct order by:

1. Read main.go and trace the execution path to verify logging calls are in correct order:
   - run() calls initializeConfig() -> logs "configuration loaded"
   - run() logs "initializing telemetry"
   - run() calls initializeTelemetry() -> returns success
   - run() logs "telemetry ready"
   - run() logs "initializing services" (or each sub-component)
   - initializeServices() logs "initializing database" -> "database ready"
   - initializeServices() logs "initializing download client" -> "download client ready"
   - run() logs "starting HTTP server"
   - startServers() starts server
   - run() logs "server ready"
   - run() logs "service ready" (final)

2. Run `go vet ./cmd/seedbox_downloader` to verify no issues with logging calls.

3. Run existing tests to ensure no regressions: `go test ./...`

No code changes needed in this task - verification only.
  </action>
  <verify>
`go vet ./cmd/seedbox_downloader` passes with no errors.
`go test ./...` passes.
Manual inspection confirms log ordering matches initialization order.
  </verify>
  <done>
Startup logging verified to match initialization order. All tests pass. No vet errors.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `go build ./cmd/seedbox_downloader` compiles successfully
2. `go vet ./cmd/seedbox_downloader` passes
3. `go test ./...` passes
4. Grep confirms phase logging: `grep -c "InfoContext.*initializing\|InfoContext.*ready" cmd/seedbox_downloader/main.go` shows multiple matches
5. No secrets in logs: `grep -E "(Password|Token|Webhook)" cmd/seedbox_downloader/main.go | grep -v envconfig | grep InfoContext` returns empty
</verification>

<success_criteria>
1. Startup logs show clear initialization phases in order (LIFECYCLE-01)
2. Each major component logs "ready" message (LIFECYCLE-02)
3. Application logs "service ready" with port and label (LIFECYCLE-03)
4. Configuration logged with safe values only (LIFECYCLE-06)
5. All tests pass, code compiles and vets cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/08-lifecycle-visibility/08-01-SUMMARY.md`
</output>
