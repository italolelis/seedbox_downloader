---
phase: 09-log-level-consistency
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/transfer/transfer.go
  - internal/downloader/downloader.go
autonomous: true

must_haves:
  truths:
    - "Polling tick does not produce INFO logs when no transfers found"
    - "Transfer discovery logs at INFO only when transfers exist"
    - "Per-file download events log at DEBUG level"
    - "Transfer-level download start logs at INFO level"
  artifacts:
    - path: "internal/transfer/transfer.go"
      provides: "Silent-when-idle polling pattern"
      contains: "DebugContext.*polling for transfers"
    - path: "internal/downloader/downloader.go"
      provides: "Per-file at DEBUG, transfer at INFO pattern"
      contains: "DebugContext.*downloading file"
  key_links:
    - from: "internal/transfer/transfer.go"
      to: "polling behavior"
      via: "watchTransfers method"
      pattern: "DebugContext.*polling"
    - from: "internal/downloader/downloader.go"
      to: "download events"
      via: "writeFile and DownloadFile methods"
      pattern: "DebugContext.*(downloading file|file downloaded)"
---

<objective>
Apply log level consistency to transfer orchestrator and downloader components.

Purpose: Reduce log noise in production by logging polling ticks at DEBUG and per-file operations at DEBUG, while keeping transfer-level events at INFO. This implements the "silent when idle" pattern where INFO logs only appear when meaningful work occurs.

Output: Modified transfer.go and downloader.go with corrected log levels
</objective>

<execution_context>
@/Users/italovietro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/italovietro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-log-level-consistency/09-RESEARCH.md
@internal/transfer/transfer.go
@internal/downloader/downloader.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Apply silent-when-idle pattern to transfer orchestrator</name>
  <files>internal/transfer/transfer.go</files>
  <action>
In watchTransfers method (around lines 137-181):

1. Change line 140 from:
   `logger.InfoContext(ctx, "watching transfers", "label", o.label)`
   to:
   `logger.DebugContext(ctx, "polling for transfers", "label", o.label)`

2. Change lines 147 from unconditional INFO to conditional:
   Replace:
   ```go
   logger.InfoContext(ctx, "active transfers", "transfer_count", len(transfers))
   ```
   With:
   ```go
   if len(transfers) > 0 {
       logger.InfoContext(ctx, "transfers found", "count", len(transfers))
   } else {
       logger.DebugContext(ctx, "no transfers found")
   }
   ```

This implements the "silent when idle" pattern where:
- Polling tick logs at DEBUG (every tick, but hidden in production)
- Transfer count logs at INFO only when work exists
- No INFO logs generated during idle polling

Preserve all other existing logic and logging statements unchanged.
  </action>
  <verify>
Run `go build ./...` to verify compilation.
Run `grep -n "DebugContext.*polling for transfers" internal/transfer/transfer.go` to confirm polling is DEBUG.
Run `grep -n "InfoContext.*transfers found" internal/transfer/transfer.go` to confirm conditional INFO.
  </verify>
  <done>
Transfer orchestrator logs "polling for transfers" at DEBUG level on every tick.
Transfer orchestrator logs "transfers found" at INFO only when count > 0.
Transfer orchestrator logs "no transfers found" at DEBUG when count == 0.
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply per-file DEBUG and transfer-level INFO to downloader</name>
  <files>internal/downloader/downloader.go</files>
  <action>
Make three changes to the downloader:

1. In DownloadFile method (line 179), change from:
   `logger.InfoContext(ctx, "downloaded and saved file", "target", targetPath)`
   to:
   `logger.DebugContext(ctx, "file downloaded", "target", targetPath)`

2. In writeFile method (line 325), change from:
   `logger.InfoContext(ctx, "downloading file", "file_path", targetPath, "file_size", humanize.Bytes(uint64(totalBytes)))`
   to:
   `logger.DebugContext(ctx, "downloading file", "file_path", targetPath, "file_size", humanize.Bytes(uint64(totalBytes)))`

3. In DownloadTransfer method (around line 115, after the logger assignment), add transfer-level INFO log:
   Add after `logger := logctx.LoggerFromContext(ctx)`:
   ```go
   logger.InfoContext(ctx, "starting download",
       "transfer_id", transfer.ID,
       "transfer_name", transfer.Name,
       "file_count", len(transfer.Files))
   ```

This implements the multi-file pattern where:
- Transfer start logs at INFO (significant business event)
- Per-file operations log at DEBUG (implementation detail)
- Transfer completion already logs at INFO in WatchDownloads (line 96)

Preserve all other existing logic and logging statements unchanged.
  </action>
  <verify>
Run `go build ./...` to verify compilation.
Run `grep -n "DebugContext.*downloading file" internal/downloader/downloader.go` to confirm per-file is DEBUG.
Run `grep -n "DebugContext.*file downloaded" internal/downloader/downloader.go` to confirm completion is DEBUG.
Run `grep -n "InfoContext.*starting download" internal/downloader/downloader.go` to confirm transfer-level INFO added.
  </verify>
  <done>
Per-file "downloading file" logs at DEBUG level.
Per-file "file downloaded" logs at DEBUG level.
Transfer-level "starting download" logs at INFO level with transfer_id, transfer_name, file_count.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Build verification:
   ```bash
   go build ./...
   ```

2. Level pattern verification:
   ```bash
   # Should show DEBUG for polling and per-file
   grep -n "DebugContext" internal/transfer/transfer.go internal/downloader/downloader.go

   # Should show INFO for transfer-level events only
   grep -n "InfoContext" internal/transfer/transfer.go internal/downloader/downloader.go
   ```

3. Test suite:
   ```bash
   go test ./...
   ```
</verification>

<success_criteria>
- [ ] Polling tick logs at DEBUG, not INFO
- [ ] Transfer discovery logs at INFO only when transfers found
- [ ] Per-file download start/complete logs at DEBUG
- [ ] Transfer-level download start logs at INFO
- [ ] All tests pass
- [ ] Code compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-log-level-consistency/09-01-SUMMARY.md`
</output>
