---
phase: 02-resource-leak-prevention
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - cmd/seedbox_downloader/main.go
autonomous: true

must_haves:
  truths:
    - "Notification loop recovers from panics without crashing the application"
    - "Panic recovery logs stack trace for debugging"
    - "Notification loop restarts after panic if context not cancelled"
    - "Exit scenarios are logged with operation and reason fields"
  artifacts:
    - path: "cmd/seedbox_downloader/main.go"
      provides: "Panic recovery in notification loop"
      contains: "recover()"
  key_links:
    - from: "setupNotificationForDownloader goroutine"
      to: "recover()"
      via: "deferred panic recovery"
      pattern: "defer func\\(\\).*recover\\(\\)"
---

<objective>
Add panic recovery to the notification loop in setupNotificationForDownloader.

Purpose: Ensure notification processing survives unexpected panics for 24/7 operation.
Output: Modified main.go with deferred panic recovery and exit logging for the notification goroutine.
</objective>

<execution_context>
@/Users/italovietro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/italovietro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-resource-leak-prevention/02-CONTEXT.md
@.planning/phases/02-resource-leak-prevention/02-RESEARCH.md
@cmd/seedbox_downloader/main.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add panic recovery to notification loop</name>
  <files>cmd/seedbox_downloader/main.go</files>
  <action>
Add import for "runtime/debug" at the top of the file (for stack traces).

Modify setupNotificationForDownloader function (lines 266-329) to add panic recovery:

1. Inside the goroutine (after `go func() {`), add deferred panic recovery:
```go
defer func() {
    if r := recover(); r != nil {
        logger.Error("notification loop panic",
            "operation", "notification_loop",
            "panic", r,
            "stack", string(debug.Stack()))

        // Restart with clean state if context not cancelled
        if ctx.Err() == nil {
            logger.Info("restarting notification loop after panic",
                "operation", "notification_loop")
            time.Sleep(time.Second) // Brief backoff before restart
            setupNotificationForDownloader(ctx, repo, downloader, cfg)
        }
    }
}()
```

2. In the ctx.Done case, add structured exit logging (enhance existing log):
```go
case <-ctx.Done():
    logger.Info("notification loop shutdown",
        "operation", "notification_loop",
        "reason", "context_cancelled")
    return
```

Note: This goroutine has NO ticker (it's event-driven via channels), so no ticker cleanup needed.
The panic recovery ensures that if any channel operation or notification call panics, the loop restarts.
  </action>
  <verify>
Run `go build ./...` to check compilation.
Grep: `grep -n "recover()" cmd/seedbox_downloader/main.go` returns a line number.
Grep: `grep -n "notification loop panic" cmd/seedbox_downloader/main.go` returns a line number.
  </verify>
  <done>
- Notification goroutine has deferred panic recovery with stack trace logging
- Panic recovery restarts the goroutine if context is not cancelled
- ctx.Done case logs structured exit with operation and reason fields
- Code compiles and passes vet
  </done>
</task>

</tasks>

<verification>
After completing the task:
1. `go build ./...` passes
2. `go vet ./...` passes
3. `grep -c "recover()" cmd/seedbox_downloader/main.go` returns at least 1
4. Panic recovery includes stack trace logging with debug.Stack()
5. Restart logic checks ctx.Err() before restarting
</verification>

<success_criteria>
- Notification loop has panic recovery with stack trace logging
- Restart logic only triggers if context is not cancelled
- Exit logging uses structured fields (operation, reason)
- Requirement RES-04 is satisfied (panic recovery for event-driven notification loop)
</success_criteria>

<output>
After completion, create `.planning/phases/02-resource-leak-prevention/02-03-SUMMARY.md`
</output>
