---
phase: 04-put-io-client-extension
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - internal/transfer/transfer.go
  - internal/dc/putio/client.go
  - internal/transfer/instrumented_client.go
autonomous: true

must_haves:
  truths:
    - "Put.io client can accept .torrent file content as bytes and upload to Put.io"
    - ".torrent content is uploaded to correct parent directory (same logic as magnet links)"
    - "Put.io automatically creates transfer when .torrent file is detected"
    - "Upload failures return specific error types (InvalidContentError, NetworkError, DirectoryError)"
    - "Existing magnet link functionality works identically after changes"
  artifacts:
    - path: "internal/transfer/transfer.go"
      provides: "TransferClient interface with AddTransferByBytes method"
      contains: "AddTransferByBytes"
    - path: "internal/dc/putio/client.go"
      provides: "Put.io client implementation of AddTransferByURL and AddTransferByBytes"
      exports: ["AddTransferByURL", "AddTransferByBytes"]
    - path: "internal/transfer/instrumented_client.go"
      provides: "Telemetry wrapper for new transfer methods"
      contains: "AddTransferByBytes"
  key_links:
    - from: "internal/dc/putio/client.go"
      to: "internal/transfer/errors.go"
      via: "import and error type usage"
      pattern: "&transfer\\.(InvalidContentError|NetworkError|DirectoryError)"
    - from: "internal/dc/putio/client.go"
      to: "putio.Files.Upload"
      via: "SDK method call"
      pattern: "c\\.putioClient\\.Files\\.Upload"
    - from: "internal/transfer/instrumented_client.go"
      to: "AddTransferByBytes"
      via: "delegation to wrapped client"
      pattern: "c\\.client\\.AddTransferByBytes"
---

<objective>
Extend the Put.io client to support .torrent file uploads via bytes with automatic transfer creation.

Purpose: Enable uploading .torrent file content directly to Put.io, which automatically detects the file type and creates a transfer. This completes Phase 4's goal of Put.io client extension.

Output: Updated TransferClient interface with new methods, Put.io client implementation, and instrumented wrapper.
</objective>

<execution_context>
@/Users/italovietro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/italovietro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-put-io-client-extension/04-RESEARCH.md (Code examples, Pattern 1: Explicit Method Naming, Pattern 4: bytes.NewReader, Pitfall 1-4)
@.planning/phases/04-put-io-client-extension/04-01-SUMMARY.md
@internal/transfer/transfer.go
@internal/dc/putio/client.go
@internal/transfer/instrumented_client.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update TransferClient interface and Put.io client methods</name>
  <files>internal/transfer/transfer.go, internal/dc/putio/client.go</files>
  <action>
**In internal/transfer/transfer.go:**

1. Add `AddTransferByBytes` method to `TransferClient` interface:
```go
type TransferClient interface {
    AddTransfer(ctx context.Context, url string, downloadDir string) (*Transfer, error)
    AddTransferByBytes(ctx context.Context, torrentBytes []byte, filename string, downloadDir string) (*Transfer, error)
    RemoveTransfers(ctx context.Context, transferIDs []string, deleteLocalData bool) error
}
```

Keep `AddTransfer` for backward compatibility - will add deprecation comment.

**In internal/dc/putio/client.go:**

1. Add constant at top of file:
```go
const maxTorrentSize = 10 * 1024 * 1024 // 10MB max torrent file size
```

2. Add `validateTorrentFilename` helper function:
```go
func validateTorrentFilename(filename string) error {
    ext := filepath.Ext(filename)
    if !strings.EqualFold(ext, ".torrent") {
        return &transfer.InvalidContentError{
            Filename: filename,
            Reason:   "file extension must be .torrent (Put.io requires extension for transfer detection)",
        }
    }
    return nil
}
```

3. Implement `AddTransferByBytes` method on `*Client`:
- Accept `ctx context.Context, torrentBytes []byte, filename string, downloadDir string`
- Validate size: return `InvalidContentError` if `len(torrentBytes) > maxTorrentSize`
- Validate extension: call `validateTorrentFilename(filename)`
- Resolve directory: call existing `findDirectoryID(ctx, downloadDir)` - wrap error in `DirectoryError` if failed
- Convert bytes to io.Reader: `bytes.NewReader(torrentBytes)`
- Upload via Put.io SDK: `c.putioClient.Files.Upload(ctx, reader, filename, dirID)`
- On upload error: return `NetworkError` with operation "upload_torrent" and API message
- After upload: check `upload.Transfer` is not nil (Put.io auto-creates transfer for .torrent)
- If `upload.Transfer` is nil: return `InvalidContentError` with reason "Put.io did not create transfer (file may not be valid torrent)"
- Convert `upload.Transfer` to `*transfer.Transfer` (same pattern as existing `AddTransfer`)
- Log: "uploading torrent file to Put.io" at start, "transfer created from torrent upload" on success

4. Add deprecation comment to existing `AddTransfer` method:
```go
// Deprecated: Use AddTransferByURL for magnet/HTTP(S) links or AddTransferByBytes for .torrent file content.
// This method will be removed in a future version.
func (c *Client) AddTransfer(ctx context.Context, url string, downloadDir string) (*Transfer, error) {
```

5. Add necessary imports at top: `"bytes"` (if not already present)
  </action>
  <verify>
Run `go build ./...` - compiles successfully.
Run `go vet ./internal/...` - no vet warnings.
  </verify>
  <done>
- TransferClient interface includes AddTransferByBytes method signature
- Put.io client implements AddTransferByBytes with:
  - 10MB size limit validation
  - .torrent extension validation
  - Directory resolution using existing helper
  - Files.Upload SDK call with bytes.NewReader
  - Transfer creation validation
  - Custom error types for all failure modes
- AddTransfer method has deprecation comment
  </done>
</task>

<task type="auto">
  <name>Task 2: Update InstrumentedTransferClient with new method</name>
  <files>internal/transfer/instrumented_client.go</files>
  <action>
Add `AddTransferByBytes` method to `InstrumentedTransferClient`:

```go
// AddTransferByBytes adds a transfer from .torrent file bytes with telemetry.
func (c *InstrumentedTransferClient) AddTransferByBytes(ctx context.Context, torrentBytes []byte, filename string, downloadDir string) (*Transfer, error) {
    var result *Transfer
    var err error

    instrumentedErr := c.telemetry.InstrumentClientOperation(ctx, c.clientType, "add_transfer_by_bytes", func(ctx context.Context) error {
        result, err = c.client.AddTransferByBytes(ctx, torrentBytes, filename, downloadDir)
        return err
    })

    if instrumentedErr != nil {
        return nil, instrumentedErr
    }

    c.telemetry.RecordTransfer(ctx, "add", "success")

    return result, nil
}
```

This follows the exact same pattern as the existing `AddTransfer` method in the same file:
- Wrap the call in `InstrumentClientOperation` for span creation
- Use "add_transfer_by_bytes" as operation name (distinct from "add_transfer")
- Record transfer metric on success
- Preserve error types through the wrapper (don't re-wrap)
  </action>
  <verify>
Run `go build ./...` - compiles successfully.
Verify method signature matches interface.
  </verify>
  <done>
InstrumentedTransferClient has AddTransferByBytes method that:
- Wraps call in telemetry instrumentation
- Uses operation name "add_transfer_by_bytes"
- Records transfer metric on success
- Follows same pattern as existing AddTransfer wrapper
  </done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for Put.io client extension</name>
  <files>internal/dc/putio/client_test.go</files>
  <action>
Create or extend `internal/dc/putio/client_test.go` with tests for the new methods:

1. **TestAddTransferByBytes_InvalidExtension** - Verify .txt extension returns InvalidContentError
   - Call with filename "test.txt"
   - Assert error is InvalidContentError
   - Assert error reason mentions ".torrent"

2. **TestAddTransferByBytes_FileTooLarge** - Verify 11MB file returns InvalidContentError
   - Create 11MB byte slice: `make([]byte, 11*1024*1024)`
   - Call with filename "large.torrent"
   - Assert error is InvalidContentError
   - Assert error reason mentions "exceeds maximum"

3. **TestValidateTorrentFilename_ValidExtensions** - Verify case-insensitive .torrent check
   - Test ".torrent", ".TORRENT", ".Torrent" all pass
   - Test ".txt", ".tor", "" all fail

Note: These are unit tests for validation logic. Integration tests with Put.io API require live credentials and are deferred to Phase 6.

Use `errors.As` to inspect error types in tests.
Import `errors` package for assertions.
  </action>
  <verify>
Run `go test ./internal/dc/putio/... -v` - all tests pass.
  </verify>
  <done>
Unit tests verify:
- Invalid file extension returns InvalidContentError
- Oversized file returns InvalidContentError with size message
- Extension validation is case-insensitive
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` compiles successfully
2. `go vet ./internal/...` reports no issues
3. `go test ./internal/transfer/... ./internal/dc/putio/... -v` passes all tests
4. TransferClient interface includes AddTransferByBytes
5. InstrumentedTransferClient implements new interface method
6. Put.io client validates size and extension before upload
</verification>

<success_criteria>
- Put.io client can upload .torrent bytes via Files.Upload SDK method
- Directory resolution uses same logic as magnet links (findDirectoryID)
- Size limit (10MB) and extension (.torrent) validated before upload
- Custom error types used for all failure modes
- Telemetry wrapper includes new method
- Unit tests verify validation logic
- Existing AddTransfer method still works (backward compatible)
</success_criteria>

<output>
After completion, create `.planning/phases/04-put-io-client-extension/04-02-SUMMARY.md`
</output>
