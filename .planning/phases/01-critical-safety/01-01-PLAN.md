---
phase: 01-critical-safety
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/dc/deluge/client.go
  - internal/notifier/discord.go
autonomous: true

must_haves:
  truths:
    - "HTTP request failures in GrabFile do not cause nil pointer panics"
    - "Discord webhook failures are logged with HTTP status codes"
    - "Error paths in both functions return errors to callers correctly"
  artifacts:
    - path: "internal/dc/deluge/client.go"
      provides: "Safe nil handling in GrabFile"
      contains: "if err != nil"
    - path: "internal/notifier/discord.go"
      provides: "HTTP status code validation"
      contains: "resp.StatusCode"
  key_links:
    - from: "internal/dc/deluge/client.go:GrabFile"
      to: "error return"
      via: "nil check before resp.Body.Close()"
      pattern: "if err != nil.*return.*nil.*fmt\\.Errorf"
    - from: "internal/notifier/discord.go:Notify"
      to: "error return"
      via: "status code check after successful request"
      pattern: "resp\\.StatusCode.*[<>!=].*200"
---

<objective>
Fix critical error handling bugs that cause crashes and silent failures in HTTP operations.

Purpose: Eliminate nil pointer panics and silent webhook failures that degrade 24/7 reliability. These bugs can cause application crashes during network errors (BUG-01) and hide notification delivery failures (BUG-02).

Output: Safe error handling in `GrabFile` and `Notify` functions with proper logging and error propagation.
</objective>

<execution_context>
@/Users/italovietro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/italovietro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-critical-safety/01-CONTEXT.md
@.planning/phases/01-critical-safety/01-RESEARCH.md
@internal/dc/deluge/client.go
@internal/notifier/discord.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix nil pointer dereference in GrabFile</name>
  <files>internal/dc/deluge/client.go</files>
  <action>
Fix the nil pointer dereference bug at line 212 of GrabFile. The current code calls `resp.Body.Close()` when `err != nil`, but if the HTTP request fails before receiving a response (network unreachable, DNS failure, connection refused), `resp` is nil and this causes a panic.

**Current buggy code (lines 208-215):**
```go
resp, err := client.Do(req)
if err != nil {
    logger.Error("failed to download file", "url", url, "err", err)
    resp.Body.Close()  // BUG: resp is nil here!
    return nil, fmt.Errorf("failed to download file: %w", err)
}
```

**Fix approach:**
1. Remove the `resp.Body.Close()` call from the error path - when `err != nil`, `resp` is nil so there's nothing to close
2. Keep the existing structured logging with url and error
3. Keep the existing error wrapping pattern (`fmt.Errorf(...%w, err)`)

**Fixed code:**
```go
resp, err := client.Do(req)
if err != nil {
    logger.Error("failed to download file", "url", url, "err", err)
    return nil, fmt.Errorf("failed to download file: %w", err)
}
```

Do NOT add any retry logic or other enhancements - this is a minimal fix to eliminate the crash.
  </action>
  <verify>
1. Run `go build ./...` - must compile without errors
2. Run `go vet ./...` - must pass with no issues
3. Manually inspect the GrabFile function to confirm resp.Body.Close() is NOT called when err != nil
  </verify>
  <done>GrabFile error path returns error without attempting to close nil response body</done>
</task>

<task type="auto">
  <name>Task 2: Add HTTP status code validation to Discord notifier</name>
  <files>internal/notifier/discord.go</files>
  <action>
Fix the silent failure bug in the Notify function. The current code returns nil even when Discord returns an error status code (4xx/5xx), causing webhook failures to be silently ignored.

**Current buggy code (lines 30-36):**
```go
resp, err := http.Post(d.WebhookURL, "application/json", bytes.NewBuffer(body))
if err != nil {
    return fmt.Errorf("failed to send request: %w", err)
}
defer resp.Body.Close()

return nil  // BUG: Returns success even if Discord returned 4xx/5xx
```

**Fix approach:**
1. After successful HTTP request (err == nil), check response status code
2. If status code is not in 2xx range (< 200 or >= 300), return an error with the status code
3. Follow the CONTEXT.md decision: "Discord failures: Log HTTP status code and error message (not full response body or request details)"
4. Keep notifications best-effort: return error (don't retry) so callers can log and continue

**Fixed code:**
```go
resp, err := http.Post(d.WebhookURL, "application/json", bytes.NewBuffer(body))
if err != nil {
    return fmt.Errorf("failed to send request: %w", err)
}
defer resp.Body.Close()

if resp.StatusCode < 200 || resp.StatusCode >= 300 {
    return fmt.Errorf("webhook failed with status %d", resp.StatusCode)
}

return nil
```

Do NOT add logging in this function - the caller handles logging. Do NOT add retry logic - Discord notifications are best-effort per CONTEXT.md.
  </action>
  <verify>
1. Run `go build ./...` - must compile without errors
2. Run `go vet ./...` - must pass with no issues
3. Manually inspect the Notify function to confirm status code check exists before returning nil
  </verify>
  <done>Notify function returns error when Discord webhook returns non-2xx status code</done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **Build verification:**
   ```bash
   cd /Users/italovietro/projects/seedbox_downloader
   go build ./...
   ```
   Expected: Clean compilation, no errors

2. **Static analysis:**
   ```bash
   go vet ./...
   ```
   Expected: No issues reported

3. **Code inspection checklist:**
   - [ ] `internal/dc/deluge/client.go:GrabFile` - no resp.Body.Close() in error path (when err != nil)
   - [ ] `internal/notifier/discord.go:Notify` - checks resp.StatusCode before returning nil

4. **Pattern verification:**
   ```bash
   # Verify nil check pattern in GrabFile
   grep -A5 "client.Do(req)" internal/dc/deluge/client.go | grep -v "resp.Body.Close()" | grep "if err != nil"

   # Verify status code check in discord.go
   grep "StatusCode" internal/notifier/discord.go
   ```
</verification>

<success_criteria>
1. `go build ./...` passes without errors
2. `go vet ./...` passes without warnings
3. GrabFile error path does not call resp.Body.Close() when HTTP request fails
4. Discord Notify returns error when webhook returns non-2xx status code
5. Both fixes use existing codebase patterns (error wrapping, no new dependencies)
</success_criteria>

<output>
After completion, create `.planning/phases/01-critical-safety/01-01-SUMMARY.md`
</output>
